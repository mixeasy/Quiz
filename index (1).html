
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Mix Easy_Online</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>-->
    <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/polyfill/3.25.1/polyfill.min.js"></script>-->
    <script>
    window.MathJax = {
      tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] }
    };
    </script>

    <!-- D√πng CDN n·∫øu online, fallback offline n·∫øu offline -->
    <script id="MathJax-script" async 
            src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"
            onerror="loadLocalMathJax()"></script>

    <script>
    function loadLocalMathJax() {
      var s = document.createElement('script');
      s.src = './MathJax-3.2.2/es5/tex-mml-chtml.js';
      s.async = true;
      document.head.appendChild(s);
    }
    </script>

    
    <style>
        :root {
            --primary-color: #2196F3;
            --secondary-color: #4CAF50;
            --warning-color: #ff9800;
            --danger-color: #d32f2f;
            --light-gray: #f0f2f5;
            --dark-gray: #555;
            --white: #ffffff;
            --border-color: #e0e0e0;
        }
        body { font-family: Arial, sans-serif; margin: 0; background: #f0f2f5; display: flex; height: 100vh; align-items: center; justify-content: center; }
        #user-info-form {
            display: flex;
            flex-direction: column;  /* x·∫øp d·ªçc */
            gap: 30px;              /* kho·∫£ng c√°ch gi·ªØa 2 kh·ªëi */
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            max-width: 600px;
            margin: auto;
            text-align: center;
        }
        #user-info-form h2 { margin-top: 0; }
        #user-info-form input { width: 100%; padding: 12px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        #user-info-form button { width: 100%; padding: 15px; border: none; border-radius: 5px; background-color: #2196F3; color: white; font-size: 16px; font-weight: bold; cursor: pointer; }
        #quiz-section { display: none; width: 100%; height: 100%; }
        .main-wrapper { display: flex; width: 100%; height: 100%; }
        #results-panel { width: 280px; flex-shrink: 0; background: #ffffff; padding: 20px; border-right: 1px solid #e0e0e0; overflow-y: auto; }
        #results-panel h3 { text-align: center; margin-top: 15px; color: #333; border-bottom: 2px solid #2196F3; padding-bottom: 10px; }
        .results-table-container { margin-bottom: 20px; }
        .results-table { width: 100%; border-collapse: separate; border-spacing: 0 10px; margin-top: 10px; }
        .results-table td { border: none; padding: 0 2px; text-align: center; font-weight: bold; font-size: 16px; }
        .results-table .question-number { width: 40px; cursor: pointer; border-radius: 5px; transition: background-color 0.2s; }
        .results-table .question-number:hover { background-color: #e9e9e9; }
        .results-table .answer-cell { width: 35px; height: 35px; line-height: 35px; border-radius: 50%; background-color: #e0e0e0; color: #555; display: inline-block; }
        .results-table .selected-answer { background-color: #2196F3; color: white; }
        .results-table .input-cell { font-style: italic; color: #888; }
        .results-table .input-cell.filled { font-style: normal; color: #333; background-color: #d4eaff; padding: 5px; border-radius: 5px; min-width: 50px; display: inline-block; }
        .results-table .choice-cell { width: 35px; height: 35px; line-height: 35px; border-radius: 50%; background-color: #e0e0e0; color: #555; display: inline-block; font-size: 14px; }
        .results-table .choice-cell.selected { background-color: #2196F3; color: white; }
        .container { flex-grow: 1; padding: 30px; background: white; overflow-y: auto; display: flex; flex-direction: column; align-items: center; }
        #quiz-content { width: 100%; max-width: 1000px; }
        #quiz-content h2 { text-align: center; text-transform: uppercase; }
        .general-content { margin-bottom: 20px; padding: 0 10px; font-size: 1.2em; font-weight: bold; text-align: justify; }
        .question { margin-bottom: 30px; display: none; }
        .question.active { display: block; }
        .question p { font-size: clamp(14px, 2vw, 40px); text-align: left; margin: 0.5em 0; }
        .question-text {
            font-size: clamp(14px, 2.2vw, 26px);
            text-align: justify;
            line-height: 1.2;
            margin: 0.5em 0;
        }
        .answers-type1 button {
            display: flex;
            align-items: flex-start;
            justify-content: flex-start;

            margin: 2px 0;
            padding: 0.45em 0.7em;

            width: 100%;
            box-sizing: border-box;

            text-align: justify;
            border: 2px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            background: #fdfdfd;

            font-size: var(--question-font-size);
            line-height: 1.45;

            transition: background 0.3s, border-color 0.3s;
        }
        .answer-letter-circle {
            display: flex;
            align-items: center;
            justify-content: center;

            width: 1.5em;
            height: 1.5em;
            min-width: 1.5em;
            min-height: 1.5em;

            border-radius: 50%;
            background-color: #e0e0e0;
            color: #333;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;

            transition: background-color 0.3s, color 0.3s;
        }
        .answer-text { flex-grow: 1; text-align: justify; }
        .answers-type1 button.selected-button { border-color: #2196F3; background: #d4eaff; }
        .answers-type1 button.selected-button .answer-letter-circle { background-color: #2196F3; color: white; }
        .options-container-type2 { display: flex; flex-direction: column; gap: 2px; }
        .option-item-type2 {
            display: flex;
            align-items: center;

            padding: 0.45em 0.75em;

            border: 1px solid #ddd;
            border-radius: 8px;

            box-sizing: border-box;
        }
        .choice-buttons-type2 { display: flex; flex-shrink: 0; gap: 5px; }
        .option-text-type2 { flex-grow: 1; margin-left: 15px; font-size: 14px; }
        .choice-buttons-type2 button {
            width: 1.5em;
            height: 1.5em;
            min-width: 1.5em;
            min-height: 1.5em;

            border-radius: 50%;
            border: 2px solid #ccc;
            background-color: #f0f0f0;
            cursor: pointer;
            font-weight: bold;

            font-size: var(--question-font-size);

            display: flex;
            align-items: center;
            justify-content: center;
        }
        .choice-buttons-type2 button.selected { background-color: #2196F3; color: white; border-color: #0d8aee; }
        .short-answer-input-type3 { padding: 12px; font-size: 14px; border: 1px solid #ccc; border-radius: 6px; width: 200px; }
        .btn-group { display: flex; justify-content: center; flex-wrap: wrap; gap: 15px; margin-top: 25px; }
        .btn-group button { padding: 0 24px; height: 56px; min-width: 180px; font-size: 18px; font-weight: 600; color: white; border: none; border-radius: 8px; cursor: pointer; }
        .nav-btn { background: #2196F3; }
        .submit-btn { background: #ff9800; }
        .xuatkq-btn { background: #FF5722; }
        .xuatcsv-btn { background: #800080; }
        .deletedatasave-btn { background: #888888; }

        /* 2 n√∫t b·∫Øt ƒë·∫ßu b√†i l√†m */
        /* Container ch·ª©a 2 n√∫t */
        .button-group {
            display: flex;
            flex-direction: column; /* X·∫øp ch·ªìng theo chi·ªÅu d·ªçc */
            gap: 12px;              /* T·∫°o kho·∫£ng c√°ch gi·ªØa 2 n√∫t */
            margin-top: 15px;
        }

        /* ƒê·ªãnh d·∫°ng chung cho n√∫t b·∫•m */
        .button-group button {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 15px;
        }

        

        /* N√∫t L√ÄM M·ªöI (C·∫£nh b√°o - M√†u x√°m ho·∫∑c cam ƒë·ªè) */
        .btn-refresh {
            background-color: #f44336 !important; /* M√†u ƒë·ªè c·∫£nh b√°o */
            color: white;
            order: 1; /* ƒê∆∞a xu·ªëng d∆∞·ªõi */
        }

        .btn-refresh:hover {
            background-color: #d32f2f !important;
        }

        /* N√∫t L√ÄM TI·∫æP (∆Øu ti√™n - M√†u xanh l√°) */
        .btn-continue {
            background-color: #2e7d32 !important; /* Xanh l√° ƒë·∫≠m */
            color: white;
            order: 2; /* ƒê∆∞a l√™n tr√™n */
        }

        .btn-continue:hover {
            background-color: #1b5e20 !important;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* ƒê√°p ·ª©ng tr√™n ƒëi·ªán tho·∫°i: n·∫øu mu·ªën 2 n√∫t n·∫±m ngang tr√™n m√†n h√¨nh r·ªông */
        @media (min-width: 600px) {
            .button-group {
                flex-direction: row; /* N·∫±m ngang tr√™n m√°y t√≠nh */
            }
            .button-group button {
                flex: 1; /* Hai n√∫t d√†i b·∫±ng nhau */
            }
        }



        .image-wrapper { display: flex; flex-direction: column; align-items: center; margin: 5px 0; gap: 0; max-width: 600px; width: auto; }
        .img-slider { width: 90%; max-width: 400px; cursor: pointer; }
        img { max-width: 100%; margin: 10px 0; border-radius: 8px; }
        #timer { background-color: #d32f2f; color: white; padding: 10px; border-radius: 8px; font-size: 1.2em; font-weight: bold; text-align: center; margin-bottom: 15px; }
        .brand { position: fixed; top: 20px; left: 20px; font-size: 28px; color: rgba(0, 0, 0, 0.15); font-family: "Segoe UI", Arial, sans-serif; font-weight: bold; transform: rotate(-15deg); pointer-events: none; user-select: none; }
        #toggle-results-btn { display: none; position: fixed; top: 15px; right: 15px; width: 50px; height: 50px; background-color: var(--primary-color); color: white; border: none; border-radius: 50%; font-size: 24px; line-height: 50px; text-align: center; cursor: pointer; z-index: 1001; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        #user-info-form {
            display: flex;
            flex-direction: column;  /* x·∫øp d·ªçc */
            gap: 30px;              /* kho·∫£ng c√°ch gi·ªØa 2 kh·ªëi */
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            max-width: 600px;
            /* margin: auto; <-- Thay ƒë·ªïi d√≤ng n√†y */
            margin-top: 20px;
            text-align: center;
        }
        #user-info-form h2 { margin-top: 0; }
        #user-info-form input { width: 100%; padding: 12px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        #user-info-form button { width: 100%; padding: 15px; border: none; border-radius: 5px; background-color: #2196F3; color: white; font-size: 16px; font-weight: bold; cursor: pointer; }
        @media (max-width: 768px) {
            .main-wrapper { flex-direction: column; }
            .container { 
                padding: 20px 15px;
                padding-top: 50px; /* üëà ch·ª´a ch·ªó cho n√∫t fixed */
            }

            #results-panel {
                position: fixed;
                top: 0;
                right: 0;
                height: 100%;
                transform: translateX(100%);
                z-index: 1000;
                box-shadow: -3px 0 10px rgba(0,0,0,0.15);
            }

            #results-panel.open { transform: translateX(0); }
            #toggle-results-btn { display: block; }
            .btn-group button { min-width: 140px; height: 50px; font-size: 16px; }
        }
        @media print {
            /* ·∫®n c√°c n√∫t kh√¥ng c·∫ßn thi·∫øt khi in */
            .btn-group, #toggle-results-btn, #results-panel {
                display: none !important;
            }

            /* ƒê·∫£m b·∫£o to√†n b·ªô n·ªôi dung hi·ªÉn th·ªã khi in */
            body, #quiz-section, .main-wrapper, .container, #quiz-content {
                height: auto !important;
                overflow: visible !important;
                display: block !important;
            }

            /* ƒê·∫∑t l·∫°i l·ªÅ v√† font ch·ªØ ƒë·ªÉ d·ªÖ ƒë·ªçc h∆°n */
            body {
                font-size: 12pt;
                margin: 0;
            }

            /* Qu·∫£n l√Ω ng·∫Øt trang cho t·ª´ng c√¢u h·ªèi */
            .question-box {
                page-break-inside: avoid;
                page-break-after: auto;
            }
        }
        #user-info-form .intro-content h3 { color: var(--primary-color); }
        #user-info-form .intro-content ul { text-align: left; list-style-type: none; padding: 0; margin: 20px 0; font-size: 1.1em; }
        #user-info-form .intro-content ul li { margin-bottom: 10px; padding-left: 20px; position: relative; }
        #user-info-form .intro-content ul li::before { content: '‚Ä¢'; color: var(--secondary-color); font-weight: bold; display: inline-block; width: 1em; margin-left: -1em; }
        .intro-content-container {
            margin-bottom: 20px;
            border-bottom: 2px solid #2196F3; /* k·∫ª v·∫°ch ph√¢n c√°ch kh·ªëi tr√™n v√† d∆∞·ªõi */
            padding-bottom: 20px;
        }
        .form-inputs-container {
            margin-top: 10px;
        }
        .intro-content-container p { font-size: 1.2em; }
        .intro-content-container ul { text-align: left; }
        /* M·ªõi th√™m n√∫t ƒë·ªïi size */
        :root { --question-font-size: clamp(14px, 2.2vw, 26px);}
        .question p,
        .question-text,
        .answers-type1 button,
        .option-text-type2,
        .choice-buttons-type2 button,
        .short-answer-input-type3 {
            font-size: var(--question-font-size);
            line-height: 1.2;
        }

        .font-control-co-chu {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;

            background: #e6f7f1;
            border: 1px solid #b7e4d8;
            border-radius: 8px;
            padding: 8px 10px;
            margin-bottom: 10px;

            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        .font-label-co-chu {
            font-size: 15px;
            font-weight: 600;
            color: #065f46;
        }

        .font-control-co-chu button {
            font-size: 15px;
            padding: 4px 10px;
            cursor: pointer;

            background: #ffffff;
            border: 1px solid #9ad1b9;
            border-radius: 6px;
        }
    </style>
</head>
<body>
    
    <div id="user-info-form">
  <div class="intro-block">
      <div class="intro-content-container">
          <div class="intro-content">
              <h2 id="quiz-intro-title"></h2>
              <h3 id="quiz-intro-time"></h3>
              <p>B√†i ki·ªÉm tra g·ªìm c√°c ph·∫ßn sau:</p>
              <ul id="intro-list"></ul>
          </div>
      </div>
  </div>

  <div class="form-block">
      <div class="form-inputs-container">
          <h2>Th√¥ng tin th√≠ sinh</h2>
          <input type="text" id="fullName" placeholder="Nh·∫≠p h·ªç v√† t√™n" autocomplete="off">
          <input type="text" id="className" placeholder="Nh·∫≠p l·ªõp" required autocomplete="off">
          <div class="button-group">
            <button id="startBtn" class="btn-continue" onclick="startQuiz()">L√†m ti·∫øp b√†i c≈© (ho·∫∑c xem l·∫°i b√†i l√†m)</button>
            <button id="newstartBtn" class="btn-refresh" onclick="delete_data_local();startQuiz();">B·∫Øt ƒë·∫ßu l√†m b√†i</button>
          </div>
      </div>
  </div>
</div>
    <div id="quiz-section">
        <div class="main-wrapper">
            <div class="container" id="quizContainer">
                <button id="toggle-results-btn">&#9776;</button> 
                <div id="quiz-content">
                    <!-- <h2>Ki·ªÉm tra gh</h2> -->
                </div> 
                <div class="btn-group">
                    <button class="nav-btn" onclick="prevQuestion()">C√¢u tr∆∞·ªõc</button>
                    <button class="nav-btn" onclick="nextQuestion()" style="background: #4CAF50;">C√¢u sau</button>
                    <button id="submitBtn" class="submit-btn" onclick="submitResults()">N·ªôp b√†i</button>
                    <!-- <button class="xuatkq-btn" onclick="xuatketqua()" >Xu·∫•t b√†i l√†m</button> -->
                    <!-- <button class="xuatcsv-btn" onclick="xuatCSV()" >Xu·∫•t CSV(Excel) ƒëi·ªÉm</button> -->
                    <button id="btn-xuatcsv" class="xuatcsv-btn" onclick="xuatCSV()">Xu·∫•t CSV(Excel) ƒëi·ªÉm</button>
                    <!--<button class="deletedatasave-btn" onclick="xoa_dulieu_luu()" >X√≥a b·ªô nh·ªõ</button>-->
                </div>
            </div>
            <div id="results-panel">
                <div class="font-control-co-chu">
                    <span class="font-label-co-chu">C·ª° ch·ªØ:</span>
                    <button onclick="decreaseFont()">A‚àí</button>
                    <button onclick="increaseFont()">A+</button>
                </div>
                <div id="timer"></div>
                <div class="results-table-container" id="results-container-type1">
                    <h3>Ph·∫ßn 1: Tr·∫Øc nghi·ªám l·ª±a ch·ªçn m·ªôt ph∆∞∆°ng √°n</h3>
                    <table class="results-table" id="results-table-type1"><tbody></tbody></table>
                </div>
                <div class="results-table-container" id="results-container-type2">
                    <h3>Ph·∫ßn 3: Tr·∫Øc nghi·ªám ƒê√∫ng/Sai</h3>
                    <table class="results-table" id="results-table-type2"><tbody></tbody></table>
                </div>
                <div class="results-table-container" id="results-container-type3">
                    <h3>Ph·∫ßn 3: C√¢u tr·∫£ l·ªùi ng·∫Øn</h3>
                    <table class="results-table" id="results-table-type3"><tbody></tbody></table>
                </div>
                <div id="results-container-general" class="results-container">
                  <h3>Ph·∫ßn 4: T·ª± lu·∫≠n</h3>
                  <table id="results-table-general" class="results-table"><tbody></tbody></table>
                </div>
            </div>
        </div>
    </div>
    <script>
const SECRET_KEY = "GV_TOAN_2026"; 

function simpleHash(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        hash = (hash << 5) - hash + str.charCodeAt(i);
        hash |= 0; // Convert to 32bit integer
    }
    return hash.toString();
}

// 1. L·∫§Y V√Ä KI·ªÇM TRA THAM S·ªê URL
const params = new URLSearchParams(location.search);
const rawData = params.get("data"); // ƒê√¢y l√† link Gist ƒë√£ m√£ h√≥a Base64
//const timeParam = params.get("time");
//const modeParam = params.get("mode");

// 3. GI·∫¢I M√É LINK D·ªÆ LI·ªÜU G·ªêC
let DATA_URL = "";
try {
    DATA_URL = atob(rawData); // Gi·∫£i m√£ Base64
} catch (e) {
    alert("‚ùå L·ªói ƒë·ªãnh d·∫°ng d·ªØ li·ªáu (Base64)");
    throw new Error("Decode failed");
}

// ================== C·∫§U H√åNH H·ªÜ TH·ªêNG QUZ ==================
let SCRIPT_URL = ""; // ƒê·ªÉ tr·ªëng, s·∫Ω l·∫•y t·ª´ JSON
let quizTitle = "Mix Easy_Online"; // Ti√™u ƒë·ªÅ m·∫∑c ƒë·ªãnh tr√™n tr√¨nh duy·ªát
let tenBaiKiemTra = "LUY·ªÜN T·∫¨P T·ªîNG H·ª¢P"; //T√™n t·∫°m th·ªùi
let TIME_LIMIT_MINUTES = 90; // Gi√° tr·ªã m·∫∑c ƒë·ªãnh n·∫øu JSON l·ªói
let timeLeft = TIME_LIMIT_MINUTES * 60; // Bi·∫øn n√†y s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t l·∫°i khi nh·∫•n Start
let QUIZ_TIME_LEFT_MODE = "cotinh"; // M·∫∑c ƒë·ªãnh
let mode_xuatketqua = "HS_DIEM";
let QUIZ_MODE_CSV = "khongchophepxuatcsv"; // M·∫∑c ƒë·ªãnh l√† ·∫©n
let shuffleOptions = {
    "shuffle_q_type1": false, "shuffle_a_type1": false, 
    "shuffle_q_type2": false, "shuffle_a_type2": false, 
    "shuffle_q_type3": false
};
let SCORING_CONFIG = {
    type1: 0.25,
    type2_1: 0.1,
    type2_2: 0.25,
    type2_3: 0.5,
    type2_4: 1.0,
    type3: 0.5
};
let QUIZ_MODE_LOCAL = "save_local"; // M·∫∑c ƒë·ªãnh l√† cho ph√©p l∆∞u
// L·∫•y th·ªùi gian t·ª´ URL (ƒë√£ qua ki·ªÉm tra sig)
let quizData = [];
let currentQuestionIndex = 0;
const userSelections = [];
let timerInterval;
let userInfo = {};

// --- QU·∫¢N L√ù LOCALSTORAGE V·ªöI PREFIX ---
let _prefix = "Quiz";

let KEY_QUIZDATA;
let KEY_SELECTION;
let KEY_TIME;
let KEY_START_TIME;
let KEY_USER_INFO;
let KEY_EXPIRED;

function initStorageKeys() {
    _prefix = (tenBaiKiemTra || "Quiz").replace(/\W+/g, "_");

    KEY_QUIZDATA   = "quizData_" + _prefix;
    KEY_SELECTION  = "quizSelections_" + _prefix;
    KEY_TIME       = "remainingTime_" + _prefix;
    KEY_START_TIME = "quizStartTime_" + _prefix;
    KEY_USER_INFO  = "userInfo_" + _prefix;
    KEY_EXPIRED    = "quizExpired_" + _prefix;

    //console.log("üîë Storage prefix:", _prefix);
}



function saveSelections() {
    // Ch·ªâ l∆∞u n·∫øu ch·∫ø ƒë·ªô l√† 'choluu'
    if (QUIZ_MODE_LOCAL === "save_local") {
        localStorage.setItem(KEY_SELECTION, JSON.stringify(userSelections));
    }
}

function loadSelections() {
    const saved = localStorage.getItem(KEY_SELECTION);
    return saved ? JSON.parse(saved) : null;
}

function clearSelections() {
    localStorage.removeItem(KEY_SELECTION);
}

function saveTimer(time) {
    // Ch·ªâ l∆∞u n·∫øu ch·∫ø ƒë·ªô l√† 'choluu'
    if (QUIZ_MODE_LOCAL === "choluu") {
        localStorage.setItem(KEY_TIME, time);
        localStorage.setItem(KEY_START_TIME, Date.now());
    }
}

// ================== LOGIC T·∫¢I D·ªÆ LI·ªÜU ==================

async function loadData() {
    try {
        const response = await fetch(DATA_URL + "?t=" + Date.now());
        if (!response.ok) throw new Error("Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi m√°y ch·ªß");

        const data = await response.json();
        window.groupedQuizData = data;

        if (data.quiz_info) {

            // ‚úÖ TITLE HI·ªÇN TH·ªä
            if (data.quiz_info.title) {
                quizTitle = data.quiz_info.title;
                document.title = quizTitle;
            }
            // ‚úÖ T√äN B√ÄI KI·ªÇM TRA (logic / storage)
            if (data.quiz_info.tenBaiKiemTra) {
                tenBaiKiemTra = data.quiz_info.tenBaiKiemTra;
            }
            // ‚úÖ TH·ªúI GIAN
            if (data.quiz_info.time_limit) {
                TIME_LIMIT_MINUTES = parseInt(data.quiz_info.time_limit);
            }
            // --- C·∫¨P NH·∫¨T MODE T·ª™ JSON ---
            if (data.quiz_info.mode_xuatketqua) {
                mode_xuatketqua = data.quiz_info.mode_xuatketqua;
                console.log("‚úÖ ƒê√£ c·∫≠p nh·∫≠t mode_xuatketqua t·ª´ JSON", mode_xuatketqua);
            }
             // --- C·∫¨P NH·∫¨T MODE QUIZ_TIME_LEFT_MODE ---
            if (data.quiz_info.quiz_time_leftmode) {
                QUIZ_TIME_LEFT_MODE = data.quiz_info.quiz_time_leftmode;
                //console.log("‚úÖ ƒê√£ c·∫≠p nh·∫≠t c·∫•u h√¨nh quiz_time_leftmode", QUIZ_TIME_LEFT_MODE);
            }

            // C·∫≠p nh·∫≠t c·∫•u h√¨nh ƒëi·ªÉm t·ª´ JSON n·∫øu c√≥
            if (data.quiz_info.scoring) {
                SCORING_CONFIG = { ...SCORING_CONFIG, ...data.quiz_info.scoring };
                //console.log("‚úÖ ƒê√£ c·∫≠p nh·∫≠t b·∫£ng ƒëi·ªÉm t·ª´ JSON");
            }
            // L·∫•y Link n·ªôp b√†i t·ª´ JSON
            if (data.quiz_info.script_url) {
                SCRIPT_URL = data.quiz_info.script_url;
            }

            // 2. X·ª≠ l√Ω ·∫©n/hi·ªán n√∫t xu·∫•t CSV ngay l·∫≠p t·ª©c d·ª±a tr√™n c·∫•u h√¨nh JSON
            if (data.quiz_info.mode_xuatcsv) {
                QUIZ_MODE_CSV = data.quiz_info.mode_xuatcsv;
                //console.log("‚úÖ ƒê√£ c·∫≠p nh·∫≠t c·∫•u h√¨nh QUIZ_MODE_CSV", QUIZ_MODE_CSV);
            }
            const btnCSV = document.getElementById("btn-xuatcsv");
            if (btnCSV) {
                if (QUIZ_MODE_CSV === "chophepxuatcsv") {
                    btnCSV.style.display = "inline-block"; // Hi·ªán n√∫t
                } else {
                    btnCSV.style.display = "none"; // ·∫®n n√∫t
                }
            }

            // 2. C·∫≠p nh·∫≠t c·∫•u h√¨nh tr·ªôn (Shuffle)
            if (data.quiz_info.shuffle_options) {
                shuffleOptions = { ...shuffleOptions, ...data.quiz_info.shuffle_options };
            }
            //L∆∞u local hay kh√¥ng
            if (data.quiz_info.mode_localstorage) {
                QUIZ_MODE_LOCAL = data.quiz_info.mode_localstorage;
            }
            const btnContinue = document.getElementById("startBtn");
            if (btnContinue && QUIZ_MODE_LOCAL === "no_save") {
                btnContinue.style.display = "none"; // ·∫®n n√∫t l√†m ti·∫øp n·∫øu kh√¥ng cho l∆∞u local
            }

        }

        // üîë Kh·ªüi t·∫°o prefix & localStorage key
        initStorageKeys();

        // üñ•Ô∏è Hi·ªÉn th·ªã ra giao di·ªán
        const titleEl = document.getElementById("quiz-title");
        if (titleEl) titleEl.textContent = quizTitle;

        const examNameEl = document.getElementById("exam-name");
        if (examNameEl) examNameEl.textContent = tenBaiKiemTra;

        //console.log("‚úÖ Quiz loaded:", tenBaiKiemTra, "|", quizTitle, "|", TIME_LIMIT_MINUTES, "ph√∫t");

    } catch (error) {
        console.error("L·ªói:", error);
        alert("L·ªói t·∫£i ƒë·ªÅ thi!");
    }
}


// ================== KH·ªûI CH·∫†Y ==================

document.addEventListener('DOMContentLoaded', async () => {
    try {
        // 1. T·∫£i d·ªØ li·ªáu JSON
        await loadData(); 
        
        // 2. Kh·ªüi t·∫°o giao di·ªán (n·∫øu c√≥ h√†m populateIntro)
        if (typeof populateIntro === "function") {
            populateIntro();
        }
        
        // 3. Hi·ªÉn th·ªã c√¥ng th·ª©c To√°n h·ªçc
        if (window.MathJax && window.MathJax.typesetPromise) {
            window.MathJax.typesetPromise();
        }

        // 4. G√°n s·ª± ki·ªán cho c√°c n√∫t ƒëi·ªÅu h∆∞·ªõng
        const btnToggle = document.getElementById('toggle-results-btn');
        if (btnToggle) {
            btnToggle.addEventListener('click', () => {
                document.getElementById('results-panel')?.classList.toggle('open');
            });
        }
    } catch (e) {
        console.error("Initialization Error:", e);
    }
});

// H√†m m·ªõi: T·∫£i th·ªùi gian ƒë√£ l∆∞u t·ª´ localStorage
//load v√† star ƒë·ªÉ h·∫øt kh√¥ng b·ªã refresh cho l√†m l·∫°i
// --- Load th·ªùi gian c√≤n l·∫°i ---
// --- Load th·ªùi gian c√≤n l·∫°i ---
// --- H√†m wrapper: g·ªçi 1 trong 2 ---
function loadTimer() {
    // S·ª≠ d·ª•ng bi·∫øn QUIZ_TIME_LEFT_MODE ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t t·ª´ JSON
    console.log("Ch·∫ø ƒë·ªô t√≠nh th·ªùi gian:", QUIZ_TIME_LEFT_MODE);

    if (QUIZ_TIME_LEFT_MODE === "cotinh") {
        return loadTimer_withElapsed();
    } else {
        return loadTimer_noElapsed();
    }
}
// --- Lo·∫°i 1: c√≥ t√≠nh th·ªùi gian t·∫Øt/m·ªü (ƒë√£ s·ª≠a kh√≥a) ---
function loadTimer_withElapsed() {
    const expired = localStorage.getItem(KEY_EXPIRED);
    if (expired === 'true') {
        return 0; // ƒë√£ h·∫øt gi·ªù r·ªìi
    }

    const savedTime = localStorage.getItem(KEY_TIME);
    const savedStartTime = localStorage.getItem(KEY_START_TIME);

    if (savedTime && savedStartTime) {
        const timeElapsed = Math.floor((Date.now() - parseInt(savedStartTime, 10)) / 1000);
        const newRemainingTime = parseInt(savedTime, 10) - timeElapsed;
        return newRemainingTime > 0 ? newRemainingTime : 0;
    }
    return null;
}
// --- Lo·∫°i 2: kh√¥ng t√≠nh th·ªùi gian t·∫Øt/m·ªü (ƒë√£ s·ª≠a kh√≥a) ---
function loadTimer_noElapsed() {
    const expired = localStorage.getItem(KEY_EXPIRED);
    if (expired === 'true') {
        return 0;
    }

    const savedTime = localStorage.getItem(KEY_TIME);
    if (savedTime) {
        return parseInt(savedTime, 10); // ch·ªâ l·∫•y l·∫°i nh∆∞ c≈©
    }
    return null;
}
        
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

function populateIntro() {
    const introTitle = document.getElementById('quiz-intro-title');
    const introTime = document.getElementById('quiz-intro-time');
    const introList = document.getElementById('intro-list');

    introTitle.innerHTML = `${tenBaiKiemTra.toUpperCase()}`;
    introTime.innerHTML = `Th·ªùi gian l√†m b√†i: ${TIME_LIMIT_MINUTES} ph√∫t`;
    introList.innerHTML = '';

    const typeMap = {
        'type1': 'Tr·∫Øc nghi·ªám l·ª±a ch·ªçn m·ªôt ph∆∞∆°ng √°n',
        'type2': 'Tr·∫Øc nghi·ªám ƒê√∫ng/Sai',
        'type3': 'C√¢u tr·∫£ l·ªùi ng·∫Øn',
        'general_content': 'C√¢u h·ªèi t·ª± lu·∫≠n'
    };

    let partNumber = 1;
    let questionCounter = 0; // d√πng ƒë·ªÉ t√≠nh s·ªë th·ª© t·ª± c√¢u li√™n t·ª•c cho t·∫•t c·∫£ ph·∫ßn

    const orderedTypes = ['type1', 'type2', 'type3', 'general_content'];

    orderedTypes.forEach(type => {
        const questions = groupedQuizData[type] || [];
        if (questions.length > 0) {
            const listItem = document.createElement('li');

            if (type === 'general_content') {
                // üß† L·∫•y HTML ph·∫ßn t·ª± lu·∫≠n v√† ƒë·∫øm s·ªë c√¢u
                const htmlContent = questions[0][0].html || "";
                const match = htmlContent.match(/C√¢u\s*\d+/g);
                const cauCount = match ? match.length : 1;

                const start_q_num = questionCounter + 1;
                const end_q_num = questionCounter + cauCount;

                listItem.textContent = `Ph·∫ßn ${partNumber}: ${typeMap[type]} (G·ªìm ${cauCount} c√¢u, t·ª´ c√¢u s·ªë ${start_q_num} ƒë·∫øn c√¢u s·ªë ${end_q_num})`;

                questionCounter += cauCount;
            } else {
                const count = questions.length;
                const start_q_num = questionCounter + 1;
                const end_q_num = questionCounter + count;

                listItem.textContent = `Ph·∫ßn ${partNumber}: ${typeMap[type]} (G·ªìm ${count} c√¢u, t·ª´ c√¢u s·ªë ${start_q_num} ƒë·∫øn c√¢u s·ªë ${end_q_num})`;

                questionCounter += count;
            }

            introList.appendChild(listItem);
            partNumber++;
        }
    });
}

  function renderTemplate(str, vars) {
    return str.replace(/\{([^}]+)\}/g, (_, expr) => {
        try {
            return Function(...Object.keys(vars), "return " + expr)(...Object.values(vars));
        } catch (e) {
            return "{" + expr + "}";
        }
    });
}

function evalExpression(expr, variables) {
    try {
        let jsExpr = expr;
        for (const [k, v] of Object.entries(variables || {})) {
            const re = new RegExp("\{" + k + "\}", "g");
            jsExpr = jsExpr.replace(re, v);
        }
        return eval(jsExpr);
    } catch (e) {
        console.error("Eval error:", e, "expr:", expr, "vars:", variables);
        return expr;
    }
}



function shuffleInPlaceByType(arr, type) {
    const indexes = arr
        .map((q, i) => [q, i])
        .filter(([q]) => q.type === type)
        .map(([, i]) => i);

    for (let i = indexes.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[indexes[i]], arr[indexes[j]]] = [arr[indexes[j]], arr[indexes[i]]];
    }
}
// S·ª≠a: Th√™m logic l∆∞u v√† t·∫£i d·ªØ li·ªáu v√†o h√†m startQuiz() (ƒê√£ s·ª≠a kh√≥a)
function startQuiz() {
    const fullName = document.getElementById('fullName').value.trim();
    const className = document.getElementById('className').value.trim();

    // --- X·ª≠ l√Ω th√¥ng tin th√≠ sinh ---
    const savedUserInfo = localStorage.getItem(KEY_USER_INFO);
    if (savedUserInfo) {
        userInfo = JSON.parse(savedUserInfo);
        if (!fullName && !className) {
            document.getElementById('fullName').value = userInfo.name;
            document.getElementById('className').value = userInfo.class;
        } else {
            userInfo = { name: fullName, class: className };
            localStorage.setItem(KEY_USER_INFO, JSON.stringify(userInfo));
        }
    } else {
        if (fullName === "" || className === "") { 
            showCustomAlert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß h·ªç t√™n v√† l·ªõp!", null, null);
            return; 
        }
        userInfo = { name: fullName, class: className };
        localStorage.setItem(KEY_USER_INFO, JSON.stringify(userInfo));
    }

    // --- N·∫°p quizData ---
    const savedQuizData = localStorage.getItem(KEY_QUIZDATA);
    if (savedQuizData) {
        // N·∫øu ƒë√£ c√≥ ƒë·ªÅ c≈© th√¨ d√πng l·∫°i, KH√îNG random n·ªØa
        quizData = JSON.parse(savedQuizData);
    } else {
        // L·∫ßn ƒë·∫ßu: random ch·ªçn c√¢u h·ªèi t·ª´ groupedQuizData
        let selectedQuizData = [];
        const orderedTypes = ['type1', 'type2', 'type3', 'general_content'];
        let originalIndex = 0;

        orderedTypes.forEach(type => {
            const groups = groupedQuizData[type];
            if (groups && groups.length > 0) {
                groups.forEach(group => {
                    if (Array.isArray(group) && group.length > 0) {
                        let chosen = group[Math.floor(Math.random() * group.length)];
                        if (chosen.variables) {
                            let vars = {};
                            for (let [k, vlist] of Object.entries(chosen.variables)) {
                                let v = vlist[Math.floor(Math.random() * vlist.length)];
                                vars[k] = parseFloat(v) || v;
                            }

                            let q = {
                                ...chosen,
                                question: renderTemplate(chosen.question_template, vars),
                                original_index: originalIndex++,
                                selected_values: vars
                            };

                            if (chosen.answers_template) {
                                q.answers = chosen.answers_template.map(a => ({
                                    text: renderTemplate(a.text, vars),
                                    is_correct: a.is_correct
                                }));
                            }

                            if (chosen.type === 'type3' && chosen.correct_answer) {
                                try {
                                    const evalVal = evalExpression(chosen.correct_answer, vars);
                                    if (typeof evalVal === "number" && isFinite(evalVal)) {
                                        q.correct_answer = String(evalVal);
                                    } else {
                                        q.correct_answer = renderTemplate(chosen.correct_answer, vars);
                                    }
                                } catch (e) {
                                    q.correct_answer = renderTemplate(chosen.correct_answer, vars);
                                }
                            }
                            selectedQuizData.push(q);
                        } else {
                            selectedQuizData.push({ ...chosen, original_index: originalIndex++ });
                        }
                    }
                });
            }
        });

        // Shuffle theo c√†i ƒë·∫∑t
        if (shuffleOptions.shuffle_q_type1) shuffleInPlaceByType(selectedQuizData, 'type1');
        if (shuffleOptions.shuffle_q_type2) shuffleInPlaceByType(selectedQuizData, 'type2');
        if (shuffleOptions.shuffle_q_type3) shuffleInPlaceByType(selectedQuizData, 'type3');
        if (shuffleOptions.shuffle_a_type1) { selectedQuizData.filter(q => q.type === 'type1').forEach(q => shuffleArray(q.answers)); }
        if (shuffleOptions.shuffle_a_type2) { selectedQuizData.filter(q => q.type === 'type2').forEach(q => { if (q.options) shuffleArray(q.options); }); }

        quizData = selectedQuizData;

        // L∆∞u nguy√™n ƒë·ªÅ random ra ƒë·ªÉ d√πng l·∫°i l·∫ßn sau
        localStorage.setItem(KEY_QUIZDATA, JSON.stringify(quizData));
    }

    // --- N·∫°p selections ---
    const savedSelections = loadSelections();
    if (savedSelections) {
        userSelections.length = 0;
        userSelections.push(...savedSelections);
    } else {
        userSelections.length = quizData.length;
        userSelections.fill(null);
        saveSelections();
    }

    // --- Hi·ªÉn th·ªã giao di·ªán ---
    document.getElementById('user-info-form').style.display = 'none';
    document.getElementById('quiz-section').style.display = 'block';

    initializeQuiz(); 

    const loadedTime = loadTimer();
    let timeToStart = loadedTime !== null ? loadedTime : TIME_LIMIT_MINUTES * 60;
    startTimer(timeToStart);
}



// S·ª≠a: H√†m startTimer() ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë·ªÉ l∆∞u v√† ti·∫øp t·ª•c ƒë·∫øm ng∆∞·ª£c
// --- B·∫Øt ƒë·∫ßu ƒë·∫øm gi·ªù ---
// --- B·∫Øt ƒë·∫ßu ƒë·∫øm gi·ªù ---
function startTimer(initialTime) {
    const timerDisplay = document.getElementById('timer');
    let timeLeft = initialTime;
    // Hi·ªÉn th·ªã ngay l·∫≠p t·ª©c khi v·ª´a nh·∫•n n√∫t, kh√¥ng ƒë·ª£i 1 gi√¢y sau m·ªõi hi·ªán
    const updateDisplay = (time) => {
        const minutes = Math.floor(time / 60);
        const seconds = time % 60;
        timerDisplay.textContent = `C√≤n l·∫°i: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    };

    // N·∫øu ƒë√£ h·∫øt gi·ªù t·ª´ tr∆∞·ªõc
    if (timeLeft <= 0) {
        timerDisplay.textContent = "H·∫øt gi·ªù!";
        lockAnswerInputs();   // kh√≥a lu√¥n input
        document.querySelectorAll('.nav-btn').forEach(btn => btn.disabled = true);
        return;
    }

    updateDisplay(timeLeft); // G·ªçi hi·ªÉn th·ªã ngay
    // L∆∞u tr·∫°ng th√°i ban ƒë·∫ßu
    saveTimer(timeLeft);

    // X√≥a interval c≈© n·∫øu c√≥ ƒë·ªÉ tr√°nh ch·∫°y song song nhi·ªÅu ƒë·ªìng h·ªì
    if (typeof timerInterval !== 'undefined') clearInterval(timerInterval);

    timerInterval = setInterval(() => {
        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            timerDisplay.textContent = "H·∫øt gi·ªù!";

            // ƒê·∫∑t c·ªù h·∫øt gi·ªù
            localStorage.setItem(KEY_TIME, 0);
            localStorage.setItem(KEY_EXPIRED, 'true');

            // Kh√≥a input + t·ª± n·ªôp b√†i
            if (!document.getElementById('submitBtn').disabled) {
                showCustomAlert(
                    "ƒê√£ h·∫øt th·ªùi gian l√†m b√†i. B√†i c·ªßa b·∫°n s·∫Ω ƒë∆∞·ª£c n·ªôp t·ª± ƒë·ªông!",
                    () => {
                        lockAnswerInputs();    
                        finalizeSubmit();      
                        document.querySelectorAll('.nav-btn').forEach(btn => btn.disabled = true);
                    }
                );
            }
        } else {
            timeLeft--;
            // C·∫≠p nh·∫≠t th·ªùi gian c√≤n l·∫°i v√†o localStorage m·ªói 5 gi√¢y
            if (timeLeft % 5 === 0) {
                saveTimer(timeLeft);
            }
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerDisplay.textContent = `C√≤n l·∫°i: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
    }, 1000);
}

// S·ª≠a: Th√™m logic t·∫£i c√¢u tr·∫£ l·ªùi ƒë√£ l∆∞u v√†o initializeQuiz()
function initializeQuiz() {
    const quizContent = document.getElementById('quiz-content');
    const tableBodies = {
        type1: document.querySelector('#results-table-type1 tbody'),
        type2: document.querySelector('#results-table-type2 tbody'),
        type3: document.querySelector('#results-table-type3 tbody')
    };

    // üÜï Th√™m body cho ph·∫ßn t·ª± lu·∫≠n
    const generalTable = document.querySelector('#results-table-general tbody');
    let hasGeneralContent = false;

    let questionHTML = '';
    let questionCounter = 0; // ch·ªâ ƒë·∫øm c√¢u h·ªèi th·ª±c s·ª± (type1/type2/type3)

    quizData.forEach((data, index) => {
        // ====== Ph·∫ßn t·ª± lu·∫≠n (general_content) ======
        // ‚ùå S·ª≠a ƒëi·ªÅu ki·ªán ki·ªÉm tra lo·∫°i c√¢u h·ªèi
        if (data.type === 'general_content_group') { 
            hasGeneralContent = true;
            
            // Ch·ªâ hi·ªÉn th·ªã kh·ªëi HTML ƒë√£ gom (ƒë√£ c√≥ ƒë·ªß n·ªôi dung v√† s·ªë th·ª© t·ª± c√¢u)
            const contentHTML = `<div class="general-content-group-container">${data.html}</div>`;
            
            questionHTML += `<div class="question" id="question-${index}" style="display:none;">
                                 ${contentHTML}
                             </div>`;
            
            // V·∫´n t·∫°o slot cho userSelections ƒë·ªÉ index kh·ªõp quizData
            userSelections[index] = { type: data.type, answer: null };

            // C·∫≠p nh·∫≠t b·∫£ng menu ph·∫£i
            const generalTable = document.querySelector('#results-table-general tbody');
            if (generalTable) {
                generalTable.innerHTML = `
                    <tr id="result-row-${index}">
                        <td class="question-number" style="cursor:pointer; font-weight:bold; text-align:center; background-color: #f0f0f0;"
                            onclick="jumpToQuestion(${index})">C√¢u h·ªèi T·ª± lu·∫≠n</td>
                    </tr>
                `;
            }
            return; // D·ª´ng x·ª≠ l√Ω cho kh·ªëi n√†y
        }

        // ====== C√¢u h·ªèi tr·∫Øc nghi·ªám ======
        questionCounter++;
        data.q_num_display = questionCounter;
        
        // S·ª≠a: N·∫øu ch∆∞a c√≥ ƒë√°p √°n, g√°n gi√° tr·ªã m·∫∑c ƒë·ªãnh, n·∫øu c√≥ th√¨ d√πng l·∫°i
        if (!userSelections[index]) {
             userSelections[index] = { type: data.type, answer: null };
        }
        
        let answersContent = '';
        let resultRow = '';
        
        switch (data.type) {
            case 'type1':
                data.answers.forEach((answer, answerIndex) => {
                    const letter = String.fromCharCode(65 + answerIndex);
                    const isSelected = userSelections[index] && userSelections[index].answer && userSelections[index].answer[0] === letter;
                    answersContent += `<button onclick="selectAnswerType1(this, ${index}, ${answerIndex})" class="${isSelected ? 'selected-button' : ''}"> 
                        <span class="answer-letter-circle ${isSelected ? 'selected-button' : ''}">${letter}</span> 
                        <span class="answer-text">${answer.text}</span> 
                    </button>`;
                });
                contentHTML = `<div class="answers-type1">${answersContent}</div>`;
                let answerCellsHTML = data.answers.map((_, i) => {
                    const letter = String.fromCharCode(65 + i);
                    const isSelected = userSelections[index] && userSelections[index].answer && userSelections[index].answer[0] === letter;
                    return `<td><div class="answer-cell ${isSelected ? 'selected-answer' : ''}" id="result-cell-${index}-${i}">${letter}</div></td>`;
                }).join('');
                resultRow = `<tr id="result-row-${index}"><td class="question-number" onclick="jumpToQuestion(${index})">${data.q_num_display}</td>${answerCellsHTML}</tr>`;
                break;
            case 'type2':
                data.options.forEach((option, optionIndex) => {
                    const userChoice = userSelections[index] && Array.isArray(userSelections[index].answer) ? userSelections[index].answer[optionIndex] : null;
                    answersContent += `<div class="option-item-type2">
                        <div class="choice-buttons-type2">
                            <button onclick="selectChoiceType2(this, ${index}, ${optionIndex}, 'ƒê')" class="${userChoice === 'ƒê' ? 'selected' : ''}">ƒê</button>
                            <button onclick="selectChoiceType2(this, ${index}, ${optionIndex}, 'S')" class="${userChoice === 'S' ? 'selected' : ''}">S</button>
                        </div>
                        <div class="option-text-type2">${option.text}</div>
                    </div>`;
                });
                contentHTML = `<div class="options-container-type2">${answersContent}</div>`;
                let choiceCellsHTML = data.options.map((_, i) => {
                    const userChoice = userSelections[index] && Array.isArray(userSelections[index].answer) ? userSelections[index].answer[i] : null;
                    return `<td><div class="choice-cell ${userChoice ? 'selected' : ''}" id="result-cell-${index}-${i}">${userChoice || '_'}</div></td>`;
                }).join('');
                resultRow = `<tr id="result-row-${index}"><td class="question-number" onclick="jumpToQuestion(${index})">${data.q_num_display}</td>${choiceCellsHTML}</tr>`;
                break;
            case 'type3':
                const savedValue = userSelections[index] && userSelections[index].answer ? userSelections[index].answer[0] : '';
                contentHTML = `<input type="text" class="short-answer-input-type3" placeholder="Nh·∫≠p ƒë√°p s·ªë..." value="${savedValue}" oninput="updateAnswerType3(${index}, this.value)">`;
                const cellText = savedValue === '' ? 'Ch∆∞a nh·∫≠p' : savedValue;
                const cellClass = savedValue === '' ? '' : 'filled';
                resultRow = `<tr id="result-row-${index}"><td class="question-number" onclick="jumpToQuestion(${index})">${data.q_num_display}</td><td class="input-cell ${cellClass}" id="result-cell-${index}">${cellText}</td></tr>`;
                break;
        }
        
        let questionWithSlider = data.question.replace(
            /<img([^>]*)>/g,
            `<div class="image-wrapper">
                <img$1 style="max-width:100%; height:auto;">
                <input type="range" min="100" max="1200" value="600" class="img-slider"
                        oninput="this.previousElementSibling.style.width=this.value+'px'">
             </div>`
        );
        questionHTML += `<div class="question" id="question-${index}">
            <p><b>C√¢u ${data.q_num_display}:</b></p>
            <div class="question-text">${questionWithSlider}</div>
            ${contentHTML}
        </div>`;
        
        if (tableBodies[data.type]) tableBodies[data.type].innerHTML += resultRow;
    });

    Object.keys(tableBodies).forEach(type => {
        if (!tableBodies[type] || tableBodies[type].innerHTML === '') {
            document.getElementById(`results-container-${type}`).style.display = 'none';
        }
    });

    // üÜï ·∫®n container t·ª± lu·∫≠n n·∫øu kh√¥ng c√≥
    const generalContainer = document.getElementById('results-container-general');
    if (generalContainer) {
        generalContainer.style.display = hasGeneralContent ? '' : 'none';
    }

    quizContent.innerHTML += questionHTML;
    if (typeof MathJax !== 'undefined') MathJax.typeset();
    
    //showQuestion(0);
    // Hi·ªán c√¢u ƒë·∫ßu ti√™n
    let firstIndex = 0;
    while (firstIndex < quizData.length && document.getElementById(`question-${firstIndex}`) == null) firstIndex++;
    showQuestion(firstIndex);
}
    

        function showQuestion(index) {
            currentQuestionIndex = index;
            document.querySelectorAll('.question, .general-content').forEach(el => {
                if(el.classList.contains('question')) el.style.display = 'none';
            });
            const targetElement = document.getElementById(`question-${index}`);
            if (targetElement) {
                targetElement.style.display = 'block';
            }
        }
        
function nextQuestion() { 
    let nextIndex = currentQuestionIndex + 1;
    if (nextIndex < quizData.length) {
        showQuestion(nextIndex);
    }
}

function prevQuestion() { 
    let prevIndex = currentQuestionIndex - 1;
    if (prevIndex >= 0) {
        showQuestion(prevIndex);
    }
}

        function jumpToQuestion(index) {
            showQuestion(index);
            if (window.innerWidth <= 768) {
                document.getElementById('results-panel').classList.remove('open');
            }
        }

        // S·ª≠a: Th√™m l·ªánh l∆∞u d·ªØ li·ªáu
function selectAnswerType1(button, qIndex, aIndex) {
    document.querySelectorAll(`#question-${qIndex} .answers-type1 button`).forEach(btn => btn.classList.remove('selected-button'));
    button.classList.add('selected-button');
    const selectedAnswerObject = quizData[qIndex].answers[aIndex];
    const isCorrect = selectedAnswerObject.is_correct;
    const selectedLetter = String.fromCharCode(65 + aIndex);
    userSelections[qIndex].answer = [selectedLetter, isCorrect];
    updateResultTableType1(qIndex, aIndex);
    saveSelections(); // L∆∞u d·ªØ li·ªáu
}

        // S·ª≠a: Th√™m l·ªánh l∆∞u d·ªØ li·ªáu
function selectChoiceType2(button, qIndex, optionIndex, choice) {
    button.parentElement.querySelectorAll('button').forEach(btn => btn.classList.remove('selected'));
    button.classList.add('selected');
    if (!Array.isArray(userSelections[qIndex].answer)) userSelections[qIndex].answer = new Array(quizData[qIndex].options.length).fill(null);
    userSelections[qIndex].answer[optionIndex] = choice;
    let correctCount = 0;
    quizData[qIndex].options.forEach((opt, i) => {
        if (userSelections[qIndex].answer[i] === opt.correct_answer) correctCount++;
    });
    userSelections[qIndex].correctCount = correctCount;
    updateResultTableType2(qIndex);
    saveSelections(); // L∆∞u d·ªØ li·ªáu
}
 
        // S·ª≠a: Th√™m l·ªánh l∆∞u d·ªØ li·ªáu
function updateAnswerType3(qIndex, value) {
    const normalize = s => (s || "").replace(/[.,]/g, "").trim().toLowerCase();
    const isCorrect = (normalize(value) === normalize(quizData[qIndex].correct_answer)) ? 1 : 0;
    userSelections[qIndex].answer = [value.trim(), isCorrect]; // S·ª≠a: l∆∞u gi√° tr·ªã trim
    updateResultTableType3(qIndex, value.trim());
    saveSelections(); // L∆∞u d·ªØ li·ªáu
}

        function updateResultTableType1(qIndex, aIndex) {
            document.querySelectorAll(`#result-row-${qIndex} .answer-cell`).forEach(cell => cell.classList.remove('selected-answer'));
            if (aIndex !== null) document.getElementById(`result-cell-${qIndex}-${aIndex}`).classList.add('selected-answer');
        }

        function updateResultTableType2(qIndex) {
            const answers = userSelections[qIndex].answer;
            answers.forEach((ans, optionIndex) => {
                const cell = document.getElementById(`result-cell-${qIndex}-${optionIndex}`);
                if (cell) {
                    cell.textContent = ans || '_';
                    cell.classList.toggle('selected', !!ans);
                }
            });
        }

        function updateResultTableType3(qIndex, value) {
            const cell = document.getElementById(`result-cell-${qIndex}`);
            cell.textContent = value === '' ? "Ch∆∞a nh·∫≠p" : value;
            cell.classList.toggle('filled', value !== '');
        }
        
        function wrapImagesWithSlider() {
            document.querySelectorAll('#quiz-content img').forEach(img => {
                if (img.closest('.image-wrapper')) return;
                const wrapper = document.createElement('div');
                wrapper.className = 'image-wrapper';
                img.parentNode.insertBefore(wrapper, img);
                wrapper.appendChild(img);
                const slider = document.createElement('input');
                slider.type = 'range';
                slider.min = 50;
                slider.max = 1200;
                slider.value = img.width || img.naturalWidth;
                slider.className = 'img-slider';
                slider.oninput = function() { img.style.width = this.value + 'px'; };
                wrapper.appendChild(slider);
            });
        }

        function showCustomAlert(message, onConfirm = null, onCancel = null) {
    const existingAlert = document.getElementById('custom-alert-overlay');
    if (existingAlert) existingAlert.remove();

    const overlay = document.createElement('div');
    overlay.id = 'custom-alert-overlay';
    overlay.style.cssText = `
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); display: flex;
    justify-content: center; align-items: flex-start; z-index: 1000;
    `;

    const alertBox = document.createElement('div');
    alertBox.style.cssText = `
        background: white; padding: 25px; border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2); text-align: center;
        max-width: 400px;
        margin-top: 10vh; /* Th√™m d√≤ng n√†y */
    `;

    const messageText = document.createElement('p');
    messageText.innerHTML = message; // cho ph√©p <b>, <br>, ...

    const buttonContainer = document.createElement('div');
    buttonContainer.style.marginTop = '20px';

    const okBtn = document.createElement('button');
    okBtn.textContent = 'OK';
    okBtn.style.cssText = `
        background-color: var(--primary-color); color: white; border: none;
        padding: 10px 20px; border-radius: 5px; cursor: pointer;
    `;
    okBtn.onclick = () => {
        overlay.remove();
        if (onConfirm) onConfirm();
    };
    buttonContainer.appendChild(okBtn);

    // Ch·ªâ t·∫°o n√∫t H·ªßy n·∫øu c√≥ callback
    if (onCancel) {
        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'H·ªßy';
        cancelBtn.style.cssText = `
            background-color: var(--danger-color); color: white; border: none;
            padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-left: 10px;
        `;
        cancelBtn.onclick = () => {
            overlay.remove();
            onCancel();
        };
        buttonContainer.appendChild(cancelBtn);
    }

    alertBox.appendChild(messageText);
    alertBox.appendChild(buttonContainer);
    overlay.appendChild(alertBox);
    document.body.appendChild(overlay);
}

function countAnsweredQuestions() {
    return quizData.reduce((count, q, idx) => {
        if (q.type === 'general_content') return count; // b·ªè qua n·ªôi dung chung
        const sel = userSelections[idx];
        if (!sel) return count;

        if (q.type === 'type1' || q.type === 'type3') {
            // Tr·∫Øc nghi·ªám & ƒëi·ªÅn s·ªë: ch·ªâ t√≠nh khi c√≥ ƒë√°p √°n
            if (sel.answer !== null) return count + 1;
        } else if (q.type === 'type2') {
            // ƒê√∫ng/Sai: ch·ªâ t√≠nh khi c√≥ √≠t nh·∫•t m·ªôt l·ª±a ch·ªçn
            if (Array.isArray(sel.answer) && sel.answer.some(a => a !== null)) {
                return count + 1;
            }
        }
        return count;
    }, 0);
}
        function submitResults() {
    const answeredCount = countAnsweredQuestions();
const totalQuestions = quizData.filter(q => q.type !== 'general_content').length;

    let message;
    if (answeredCount < totalQuestions) {
        message = `B·∫°n m·ªõi l√†m ${answeredCount}/${totalQuestions} c√¢u. B·∫°n c√≥ ch·∫Øc mu·ªën n·ªôp b√†i?`;
    } else {
        message = `B·∫°n ƒë√£ l√†m ƒë·∫ßy ƒë·ªß ${answeredCount}/${totalQuestions} c√¢u. B·∫°n c√≥ ch·∫Øc mu·ªën n·ªôp b√†i?`;
    }

    showCustomAlert(
        message,
        () => finalizeSubmit(), // OK th√¨ n·ªôp
        () => {}                // Cancel th√¨ th√¥i
    );
}


function lockAnswerInputs() {
    document.querySelectorAll('#quiz-content input, #quiz-content textarea, #quiz-content select, #quiz-content button').forEach(el => {
        el.disabled = true;
    });
    // Gi·ªØ n√∫t Xu·∫•t k·∫øt qu·∫£ ho·∫°t ƒë·ªông
    //const exportBtn = document.getElementById('exportBtn') || document.getElementById('printBtn');
    //if (exportBtn) exportBtn.disabled = false;
}
function xoa_dulieu_luu(){
    message = `B·∫°n c√≥ ch·∫Øc l√† mu·ªën mu·ªën x√≥a d·ªØ li·ªáu ƒë√£ l∆∞u tr∆∞·ªõc ƒë√≥`;
        showCustomAlert(
            message,
            () => {
                delete_data_local();
                showCustomAlert("‚úÖ ƒê√£ x√≥a xong", null, null);
                },
            () => {}
        );
}

//C·∫≠p nh·∫≠t l·ªói th·ªùi gian
function delete_data_local() {
    clearSelections(); // ƒë√£ ƒë∆∞·ª£c s·ª≠a
    localStorage.removeItem(KEY_USER_INFO); 
    // X√≥a th·ªùi gian
    localStorage.removeItem(KEY_TIME); 
    localStorage.removeItem(KEY_START_TIME); 
    // X√≥a ƒë·ªÅ c≈© & tr·∫°ng th√°i h·∫øt gi·ªù
    localStorage.removeItem(KEY_QUIZDATA); 
    localStorage.removeItem(KEY_EXPIRED); 
}
function finalizeSubmit() {
    const submitBtn = document.getElementById('submitBtn');
    clearInterval(timerInterval);
    submitBtn.disabled = true;
    submitBtn.textContent = 'ƒêang n·ªôp b√†i...';

    if (!SCRIPT_URL || !/^https?:\/\//.test(SCRIPT_URL)) {
         showCustomAlert(
        "‚ùå Link n·ªôp b√†i kh√¥ng t·ªìn t·∫°i ho·∫∑c kh√¥ng h·ª£p l·ªá!<br>üëâ H√£y b·∫•m n√∫t <b>OK</b> ƒë·ªÉ xem b√†i l√†m.",
        function() {
            // callback khi b·∫•m OK
            xuatketqua();
            submitBtn.disabled = false;
            submitBtn.textContent = 'N·ªôp b√†i';
        },
        function() { 
            submitBtn.disabled = false;
            submitBtn.textContent = 'N·ªôp b√†i';
        } // ch·ªâ ƒë·ªÉ hi·ªán n√∫t H·ªßy
    );
    return; // ngƒÉn ch·∫∑n ch·∫°y xuatketqua() ngay l·∫≠p t·ª©c
    }

    const answersFormatted = [];
    const resultsFormatted = [];
    const typesFormatted = [];

    const originalOrderData = quizData
        .filter(q => q.type !== 'general_content')
        .sort((a, b) => a.original_index - b.original_index);

    originalOrderData.forEach(originalQuestion => {
        const currentIndex = quizData.findIndex(q => q.original_index === originalQuestion.original_index);
        const sel = userSelections[currentIndex];

        if (!sel) {
            answersFormatted.push("");
            resultsFormatted.push("");
            typesFormatted.push(originalQuestion.type);
        } else {
            typesFormatted.push(sel.type);
            if (sel.type === 'type1' || sel.type === 'type3') {
                answersFormatted.push(sel.answer ? sel.answer[0] : "");
                resultsFormatted.push(sel.answer ? sel.answer[1] : 0);
            } else if (sel.type === 'type2') {
                answersFormatted.push(Array.isArray(sel.answer) ? sel.answer.join(",") : "");
                resultsFormatted.push(sel.correctCount ?? 0);
            }
        }
    });

    const payload = {
        ...userInfo,
        quizName: tenBaiKiemTra,
        answers: answersFormatted,
        results: resultsFormatted,
        questionTypes: typesFormatted,
        sheetName: (window.groupedQuizData.quiz_info && window.groupedQuizData.quiz_info.sheet_name) 
               ? window.groupedQuizData.quiz_info.sheet_name : "General"
    };

    fetch(SCRIPT_URL, {
        method: 'POST',
        mode: 'no-cors', // S·ª≠ d·ª•ng no-cors
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(() => { // Thay ƒë·ªïi response => {} th√†nh () => {}
        //showCustomAlert("‚úÖ ƒê√£ g·ª≠i b√†i th√†nh c√¥ng! K·∫øt qu·∫£ c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n.", null, null, true);
        
        //submitBtn.textContent = 'ƒê√£ n·ªôp';
        //lockAnswerInputs();
        showCustomAlert(
        "‚úÖ ƒê√£ g·ª≠i b√†i th√†nh c√¥ng! K·∫øt qu·∫£ c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n.",
        function() {
            // callback khi b·∫•m OK
            xuatketqua();
            submitBtn.textContent = 'ƒê√£ n·ªôp';
            lockAnswerInputs();
        },
        null
        );
    })
    .catch(error => {
        console.error('Error:', error);
        //showCustomAlert("‚ùå Ch∆∞a n·ªôp b√†i ƒë∆∞·ª£c do l·ªói m·∫°ng ho·∫∑c link sai.<br>üëâ H√£y b·∫•m n√∫t <b>OK</b> ƒë·ªÉ xem b√†i l√†m.", null, null, true);
        
        //submitBtn.disabled = false;
        //submitBtn.textContent = 'N·ªôp b√†i';
        showCustomAlert(
        "‚ùå Ch∆∞a n·ªôp b√†i ƒë∆∞·ª£c do l·ªói m·∫°ng ho·∫∑c link sai.<br>üëâ H√£y b·∫•m n√∫t <b>OK</b> ƒë·ªÉ xem b√†i l√†m.",
        function() {
            // callback khi b·∫•m OK
            xuatketqua();
            submitBtn.disabled = false;
            submitBtn.textContent = 'N·ªôp b√†i';
        },
        function() {
            submitBtn.disabled = false;
            submitBtn.textContent = 'N·ªôp b√†i';
         } // ch·ªâ ƒë·ªÉ hi·ªán n√∫t H·ªßy th√¨ ƒë√™ tr·ªëng c√°c h√†m
        );
    });
}
function xuatketqua(){
    //let mode_xuatketqua = getParam("mode") || "HS";
    console.log("ƒêang xu·∫•t k·∫øt qu·∫£ v·ªõi ch·∫ø ƒë·ªô:", mode_xuatketqua);
    let message;
    if (mode_xuatketqua === "GV_TL") {
       showResults_GV();
    } else if (mode_xuatketqua === "GV") {
        showResults_GV_koTL();
    } else if (mode_xuatketqua === "HS_DIEM") {
        showResults_HS_DIEM();
    } else {
        showResults_HS();
    }
}

function showResults_GV() {
        const quizContent = document.getElementById('quiz-content');
        quizContent.innerHTML = '';

        const resultsTitle = document.createElement('h2');
        resultsTitle.innerHTML = `H·ªç v√† t√™n: ${userInfo.name} - L·ªõp: ${userInfo.class}`;
        quizContent.appendChild(resultsTitle);

        // T·∫°o s·∫µn ch·ªó hi·ªÉn th·ªã t·ªïng ƒëi·ªÉm (ch∆∞a c√≥ s·ªë)
        const scoreSummary = document.createElement('h3');
        scoreSummary.style.color = 'var(--primary-color)';
        scoreSummary.style.fontWeight = 'bold';
        scoreSummary.innerHTML = `T·ªïng ƒëi·ªÉm: <span style="color: green; font-size: 1.2em;">...</span>`;
        quizContent.appendChild(scoreSummary);

        // Khai b√°o gi√° tr·ªã ƒëi·ªÉm cho t·ª´ng lo·∫°i c√¢u h·ªèi
        // S·ª≠ d·ª•ng gi√° tr·ªã t·ª´ c·∫•u h√¨nh ƒë√£ load t·ª´ JSON
        const diem_type1 = SCORING_CONFIG.type1;
        const diem_type2_1 = SCORING_CONFIG.type2_1;
        const diem_type2_2 = SCORING_CONFIG.type2_2;
        const diem_type2_3 = SCORING_CONFIG.type2_3;
        const diem_type2_4 = SCORING_CONFIG.type2_4;
        const diem_type3 = SCORING_CONFIG.type3;

        let totalScore = 0;
        //const diem_type1 = 0.25;
        //const diem_type2_1 = 0.1; // ƒë√∫ng 1 k√≠ t·ª± ƒë√°p √°n
        //const diem_type2_2 = 0.25; // ƒë√∫ng 2 k√≠ t·ª± ƒë√°p √°n
        //const diem_type2_3 = 0.5; // ƒë√∫ng 3 k√≠ t·ª± ƒë√°p √°n
        //const diem_type2_4 = 1; // ƒë√∫ng 4 k√≠ t·ª± ƒë√°p √°n
        //const diem_type3 = 1;
        //let totalScore = 0;
        
        // B·∫£ng th·ªëng k√™ t·ªïng h·ª£p (t∆∞∆°ng t·ª± Google Sheet)
        const summaryTable = document.createElement('table');
        summaryTable.style.width = '100%';
        summaryTable.style.borderCollapse = 'collapse';
        summaryTable.style.marginBottom = '20px';
        summaryTable.style.boxShadow = '0 2px 5px rgba(0,0,0,0.05)';
        
        // Th√™m c√°c h√†ng ti√™u ƒë·ªÅ
        const headers = ['C√¢u', 'Tr·∫£ l·ªùi HS', 'ƒê√°p √°n ƒë·ªÅ thi', 'So s√°nh', 'ƒêi·ªÉm'];
        const headerRow = summaryTable.insertRow();
        headers.forEach(headerText => {
            const th = document.createElement('th');
            th.style.border = '1px solid #ccc';
            th.style.padding = '8px';
            th.style.backgroundColor = 'var(--light-gray)';
            th.style.fontWeight = 'bold';
            th.textContent = headerText;
            headerRow.appendChild(th);
        });

        // Th√™m c√°c h√†ng d·ªØ li·ªáu
        quizData.forEach((q, i) => {
            if (q.type === 'general_content_group') return;
            
            const sel = userSelections[i];
            let userAnswerText = '‚Äî';
            let correctAnswerText = '';
            let resultText = '‚Äî';
            let questionScore = 0;
            
            if (q.type === 'type1') {
                const correctAns = q.answers.find(ans => ans.is_correct);
                correctAnswerText = correctAns ? String.fromCharCode(65 + q.answers.indexOf(correctAns)) : '‚Äî';
                userAnswerText = sel && sel.answer ? sel.answer[0] : '‚Äî';
                resultText = sel && sel.answer && sel.answer[1] ? '1' : '0'; // ƒê√£ s·ª≠a
                if (sel && sel.answer && sel.answer[1]) {
                    questionScore = diem_type1;
                }
            } else if (q.type === 'type2') {
                correctAnswerText = q.options.map(opt => opt.correct_answer).join('');
                userAnswerText = sel && Array.isArray(sel.answer) ? sel.answer.join('') : '‚Äî';
                
                const subQuestionCorrectCount = sel ? (sel.correctCount ?? 0) : 0;
                resultText = `${subQuestionCorrectCount}`; // ƒê√£ s·ª≠a
                
                // Logic t√≠nh ƒëi·ªÉm m·ªõi cho type2
                switch (subQuestionCorrectCount) {
                    case 1:
                        questionScore = diem_type2_1;
                        break;
                    case 2:
                        questionScore = diem_type2_2;
                        break;
                    case 3:
                        questionScore = diem_type2_3;
                        break;
                    case 4:
                        questionScore = diem_type2_4;
                        break;
                    default:
                        questionScore = 0;
                }

           } else if (q.type === 'type3') {
    if (sel && sel.answer !== null) {
        userAnswerText = `${sel.answer[0]}`;
        isCorrect = !!sel.answer[1];
        resultText = isCorrect ? "1" : "0";   // ‚úÖ c√≥ tr·∫£ l·ªùi ‚Üí so s√°nh ƒë√∫ng/sai
        if (isCorrect) {
            questionScore = diem_type3;
        }
    } else {
        userAnswerText = "‚Äî";
        resultText = "0";                     // ‚úÖ kh√¥ng tr·∫£ l·ªùi ‚Üí c≈©ng coi l√† sai
    }

    if (q.correct_answer) {
        if (q.variables) {
            const evalVal = evalExpression(q.correct_answer, q.variables);
            correctAnswerText = `${evalVal}`;
        } else {
            correctAnswerText = `${q.correct_answer}`;
        }
    }
}
            
            totalScore += questionScore;

            const row = summaryTable.insertRow();
            const questionNumCell = row.insertCell();
            questionNumCell.style.border = '1px solid #ccc';
            questionNumCell.style.padding = '8px';
            questionNumCell.textContent = `C√¢u ${q.q_num_display || (i + 1)}`;

            const userAnswerCell = row.insertCell();
            userAnswerCell.style.border = '1px solid #ccc';
            userAnswerCell.style.padding = '8px';
            userAnswerCell.textContent = userAnswerText;
            userAnswerCell.style.color = (resultText.startsWith('1/1') || resultText.includes('/4')) ? 'green' : 'red';

            const correctAnswerCell = row.insertCell();
            correctAnswerCell.style.border = '1px solid #ccc';
            correctAnswerCell.style.padding = '8px';
            correctAnswerCell.textContent = correctAnswerText;
            correctAnswerCell.style.color = 'green';
            
            const resultCell = row.insertCell();
            resultCell.style.border = '1px solid #ccc';
            resultCell.style.padding = '8px';
            resultCell.style.fontWeight = 'bold';
            resultCell.textContent = resultText;
            resultCell.style.color = (resultText === '1' || resultText === '4') ? 'green' : 'red';

            const scoreCell = row.insertCell();
            scoreCell.style.border = '1px solid #ccc';
            scoreCell.style.padding = '8px';
            scoreCell.style.fontWeight = 'bold';
            scoreCell.textContent = questionScore.toFixed(2);
        });

        quizContent.appendChild(summaryTable);
        // G·ª≠i t·ªïng ƒëi·ªÉm l√™n g·∫ßn t√™n h·ªçc sinh
        scoreSummary.innerHTML = `T·ªïng ƒëi·ªÉm: <span style="color: green; font-size: 1.2em;">${totalScore.toFixed(2)}</span>`;
        
        // B·∫Øt ƒë·∫ßu hi·ªÉn th·ªã chi ti·∫øt t·ª´ng c√¢u
        const detailTitle = document.createElement('h3');
        detailTitle.innerHTML = 'Chi ti·∫øt t·ª´ng c√¢u';
        detailTitle.style.borderTop = '1px solid #ccc';
        detailTitle.style.paddingTop = '20px';
        detailTitle.style.marginTop = '20px';
        quizContent.appendChild(detailTitle);

        // Hi·ªÉn th·ªã chi ti·∫øt t·ª´ng c√¢u h·ªèi nh∆∞ c≈©
        quizData.forEach((q, i) => {
            // üÜï X·ª≠ l√Ω kh·ªëi T·ª± lu·∫≠n m·ªõi (general_content_group)
            if (q.type === 'general_content_group') { 
                
                // 1. **B·ªé QUA** vi·ªác hi·ªÉn th·ªã kh·ªëi HTML t·ªïng th·ªÉ (q.html)
                //    Ta s·∫Ω hi·ªÉn th·ªã t·ª´ng c√¢u h·ªèi con v√† l·ªùi gi·∫£i c·ªßa n√≥.

                // 2. L·∫∑p qua t·ª´ng c√¢u h·ªèi T·ª± lu·∫≠n chi ti·∫øt
                if (q.questions) {
                    q.questions.forEach((subQ, j) => {
                        const questionNumber = j + 1; // S·ªë th·ª© t·ª± c√¢u con (1, 2, 3...)

                        // A. Hi·ªÉn th·ªã C√¢u h·ªèi (C√¢u 1. N·ªôi dung, C√¢u 2. N·ªôi dung)
                        const questionBox = document.createElement('div');
                        questionBox.className = 'question-box general-sub-question';
                        questionBox.style.marginBottom = '5px';
                        questionBox.style.marginTop = '20px'; // Kho·∫£ng c√°ch gi·ªØa c√°c c√¢u
                        
                        // L·∫•y n·ªôi dung c√¢u h·ªèi t·ª´ subQ.html v√† th√™m prefix 'C√¢u n.'
                        questionBox.innerHTML = `
                            <div class="question-text" style="font-size: 1.1em;"> 
                                <span style="font-weight: bold; color: #333; margin-right: 5px;">
                                    C√¢u ${questionNumber}.
                                </span>
                                ${subQ.html}
                            </div>
                        `;
                        quizContent.appendChild(questionBox);
                        
                        // B. Hi·ªÉn th·ªã L·ªùi gi·∫£i (n·∫øu c√≥)
                        if (subQ.solution && subQ.solution.trim() !== "") {
                            const solutionBox = document.createElement('div');
                            solutionBox.className = 'solution-box';
                            solutionBox.style.marginTop = '0px';
                            solutionBox.style.marginBottom = '25px'; // Kho·∫£ng c√°ch sau l·ªùi gi·∫£i
                            solutionBox.style.padding = '12px';
                            solutionBox.style.borderLeft = '4px solid var(--secondary-color)';
                            solutionBox.style.backgroundColor = '#f0fff0'; 
                            
                            solutionBox.innerHTML = `
                                <p style="font-weight: bold; margin-bottom: 5px; color: var(--secondary-color); font-size: 1.1em;">
                                    L·ªùi gi·∫£i:
                                </p>
                                <div>${subQ.solution}</div>
                            `;
                            
                            quizContent.appendChild(solutionBox);
                        }
                    });
                }
                
                return; // K·∫øt th√∫c x·ª≠ l√Ω cho kh·ªëi T·ª± lu·∫≠n
            }

            const questionBox = document.createElement('div');
            questionBox.className = 'question-box';
            questionBox.style.marginBottom = '30px';
            questionBox.style.padding = '15px';
            questionBox.style.border = '1px solid #ccc';
            questionBox.style.borderRadius = '8px';

            const questionHeader = document.createElement('h4');
            questionHeader.innerHTML = `C√¢u ${q.q_num_display || (i + 1)}: ${q.question}`;
            questionHeader.style.color = 'var(--dark-gray)';
            questionBox.appendChild(questionHeader);

            const sel = userSelections[i];
            let userAnswerText = 'Ch∆∞a tr·∫£ l·ªùi';
            let correctAnswerText = '';
            let isCorrect = false;

            if (q.type === 'type1') {
                const answersList = document.createElement('ul');
                answersList.style.listStyleType = 'none';
                answersList.style.padding = '0';
                answersList.style.fontSize = '1.1em';
                answersList.style.lineHeight = '1.6';

                q.answers.forEach((ans, idx) => {
                    const li = document.createElement('li');
                    const letter = String.fromCharCode(65 + idx);
                    li.innerHTML = `${letter}. ${ans.text}`;
                    if (sel && sel.answer && sel.answer[0] === letter) {
                        li.style.fontWeight = 'bold';
                        li.style.color = sel.answer[1] ? 'green' : 'red';
                        userAnswerText = `**${letter}**`;
                    }
                    if (ans.is_correct) {
                        correctAnswerText = `**${letter}**`;
                    }
                    answersList.appendChild(li);
                });
                questionBox.appendChild(answersList);
                isCorrect = (sel && !!sel.answer && sel.answer[1]);
            } else if (q.type === 'type2') {
                const optionsList = document.createElement('ul');
                optionsList.style.listStyleType = 'none';
                optionsList.style.padding = '0';
                optionsList.style.fontSize = '1.1em';
                optionsList.style.lineHeight = '1.6';

                userAnswerText = [];
                correctAnswerText = [];
                let subQuestionCorrectCount = 0;

                q.options.forEach((opt, idx) => {
                    const li = document.createElement('li');
                    const label = String.fromCharCode(97 + idx); // 'a' + idx
                    li.innerHTML = `${label}) ${opt.text}`;
                    li.style.marginBottom = '5px';

                    const userChoice = sel && Array.isArray(sel.answer) ? sel.answer[idx] : null;
                    const correctChoice = opt.correct_answer;
                    
                    if (userChoice !== null) {
                        li.innerHTML += ` ‚Üí B·∫°n ch·ªçn: ${userChoice}`;
                        if (userChoice === correctChoice) {
                            li.style.color = 'green';
                            subQuestionCorrectCount++;
                        } else {
                            li.style.color = 'red';
                        }
                    } else {
                        li.style.color = 'var(--dark-gray)';
                        li.innerHTML += ` ‚Üí Ch∆∞a tr·∫£ l·ªùi`;
                    }
                    userAnswerText.push(userChoice || '-');
                    correctAnswerText.push(correctChoice);
                    optionsList.appendChild(li);
                });
                questionBox.appendChild(optionsList);
                userAnswerText = userAnswerText.join(', ');
                correctAnswerText = correctAnswerText.join(', ');
                isCorrect = (subQuestionCorrectCount === q.options.length);
            } else if (q.type === 'type3') {
    if (sel && sel.answer !== null) {
        userAnswerText = `${sel.answer[0]}`;
        isCorrect = !!sel.answer[1];
    }
    if (q.variables) {
        const evalVal = evalExpression(q.correct_answer, q.variables);
        correctAnswerText = String(evalVal);
    } else {
        correctAnswerText = `${q.correct_answer}`;
    }
}
            
            const answerDisplay = document.createElement('p');
            answerDisplay.innerHTML = `
                <strong>C√¢u tr·∫£ l·ªùi c·ªßa b·∫°n:</strong> <span style="color: ${isCorrect ? 'green' : 'red'};">${userAnswerText}</span><br>
                <strong>ƒê√°p √°n ƒë√∫ng:</strong> <span style="color: green;">${correctAnswerText}</span>
            `;
            answerDisplay.style.borderTop = '1px dashed #ccc';
            answerDisplay.style.paddingTop = '10px';
            answerDisplay.style.marginTop = '15px';
            questionBox.appendChild(answerDisplay);
            quizContent.appendChild(questionBox);

            // N·∫øu c√≥ l·ªùi gi·∫£i th√¨ hi·ªÉn th·ªã
            if (q.solution && q.solution.trim() !== "") {
                const solutionBox = document.createElement('div');
                solutionBox.className = 'solution-box';
                solutionBox.style.marginTop = '10px';
                solutionBox.style.padding = '10px';
                solutionBox.style.borderLeft = '4px solid #4CAF50';
                solutionBox.style.backgroundColor = '#f9f9f9';
                solutionBox.innerHTML = `<b>L·ªùi gi·∫£i:</b><br>${q.solution}`;
                questionBox.appendChild(solutionBox);
            }
        });
        if (typeof MathJax !== 'undefined') {
            MathJax.typesetPromise([quizContent]);
        }
        // üîí Sau khi xu·∫•t k·∫øt qu·∫£: ·∫©n ho√†n to√†n panel b√™n ph·∫£i
        const resultsPanel = document.getElementById('results-panel');
        const toggleBtn = document.getElementById('toggle-results-btn');

        if (resultsPanel) {
            resultsPanel.style.display = 'none';
        }

        if (toggleBtn) {
            toggleBtn.style.display = 'none';
        }
    }
function showResults_GV_koTL() {
        const quizContent = document.getElementById('quiz-content');
        quizContent.innerHTML = '';

        const resultsTitle = document.createElement('h2');
        resultsTitle.innerHTML = `H·ªç v√† t√™n: ${userInfo.name} - L·ªõp: ${userInfo.class}`;
        quizContent.appendChild(resultsTitle);
        // T·∫°o s·∫µn ch·ªó hi·ªÉn th·ªã t·ªïng ƒëi·ªÉm (ch∆∞a c√≥ s·ªë)
        const scoreSummary = document.createElement('h3');
        scoreSummary.style.color = 'var(--primary-color)';
        scoreSummary.style.fontWeight = 'bold';
        scoreSummary.innerHTML = `T·ªïng ƒëi·ªÉm: <span style="color: green; font-size: 1.2em;">...</span>`;
        quizContent.appendChild(scoreSummary);

        // Khai b√°o gi√° tr·ªã ƒëi·ªÉm cho t·ª´ng lo·∫°i c√¢u h·ªèi
        // S·ª≠ d·ª•ng gi√° tr·ªã t·ª´ c·∫•u h√¨nh ƒë√£ load t·ª´ JSON
        const diem_type1 = SCORING_CONFIG.type1;
        const diem_type2_1 = SCORING_CONFIG.type2_1;
        const diem_type2_2 = SCORING_CONFIG.type2_2;
        const diem_type2_3 = SCORING_CONFIG.type2_3;
        const diem_type2_4 = SCORING_CONFIG.type2_4;
        const diem_type3 = SCORING_CONFIG.type3;

        let totalScore = 0;
        //const diem_type1 = 0.25;
        //const diem_type2_1 = 0.1; // ƒë√∫ng 1 k√≠ t·ª± ƒë√°p √°n
        //const diem_type2_2 = 0.25; // ƒë√∫ng 2 k√≠ t·ª± ƒë√°p √°n
        //const diem_type2_3 = 0.5; // ƒë√∫ng 3 k√≠ t·ª± ƒë√°p √°n
        //const diem_type2_4 = 1; // ƒë√∫ng 4 k√≠ t·ª± ƒë√°p √°n
        //const diem_type3 = 1;
        //let totalScore = 0;
        
        // B·∫£ng th·ªëng k√™ t·ªïng h·ª£p (t∆∞∆°ng t·ª± Google Sheet)
        const summaryTable = document.createElement('table');
        summaryTable.style.width = '100%';
        summaryTable.style.borderCollapse = 'collapse';
        summaryTable.style.marginBottom = '20px';
        summaryTable.style.boxShadow = '0 2px 5px rgba(0,0,0,0.05)';
        
        // Th√™m c√°c h√†ng ti√™u ƒë·ªÅ
        const headers = ['C√¢u', 'Tr·∫£ l·ªùi HS', 'ƒê√°p √°n ƒë·ªÅ thi', 'So s√°nh', 'ƒêi·ªÉm'];
        const headerRow = summaryTable.insertRow();
        headers.forEach(headerText => {
            const th = document.createElement('th');
            th.style.border = '1px solid #ccc';
            th.style.padding = '8px';
            th.style.backgroundColor = 'var(--light-gray)';
            th.style.fontWeight = 'bold';
            th.textContent = headerText;
            headerRow.appendChild(th);
        });

        // Th√™m c√°c h√†ng d·ªØ li·ªáu
        quizData.forEach((q, i) => {
            if (q.type === 'general_content_group') return;
            
            const sel = userSelections[i];
            let userAnswerText = '‚Äî';
            let correctAnswerText = '';
            let resultText = '‚Äî';
            let questionScore = 0;
            
            if (q.type === 'type1') {
                const correctAns = q.answers.find(ans => ans.is_correct);
                correctAnswerText = correctAns ? String.fromCharCode(65 + q.answers.indexOf(correctAns)) : '‚Äî';
                userAnswerText = sel && sel.answer ? sel.answer[0] : '‚Äî';
                resultText = sel && sel.answer && sel.answer[1] ? '1' : '0'; // ƒê√£ s·ª≠a
                if (sel && sel.answer && sel.answer[1]) {
                    questionScore = diem_type1;
                }
            } else if (q.type === 'type2') {
                correctAnswerText = q.options.map(opt => opt.correct_answer).join('');
                userAnswerText = sel && Array.isArray(sel.answer) ? sel.answer.join('') : '‚Äî';
                
                const subQuestionCorrectCount = sel ? (sel.correctCount ?? 0) : 0;
                resultText = `${subQuestionCorrectCount}`; // ƒê√£ s·ª≠a
                
                // Logic t√≠nh ƒëi·ªÉm m·ªõi cho type2
                switch (subQuestionCorrectCount) {
                    case 1:
                        questionScore = diem_type2_1;
                        break;
                    case 2:
                        questionScore = diem_type2_2;
                        break;
                    case 3:
                        questionScore = diem_type2_3;
                        break;
                    case 4:
                        questionScore = diem_type2_4;
                        break;
                    default:
                        questionScore = 0;
                }

           } else if (q.type === 'type3') {
    if (sel && sel.answer !== null) {
        userAnswerText = `${sel.answer[0]}`;
        isCorrect = !!sel.answer[1];
        resultText = isCorrect ? "1" : "0";   // ‚úÖ c√≥ tr·∫£ l·ªùi ‚Üí so s√°nh ƒë√∫ng/sai
        if (isCorrect) {
            questionScore = diem_type3;
        }
    } else {
        userAnswerText = "‚Äî";
        resultText = "0";                     // ‚úÖ kh√¥ng tr·∫£ l·ªùi ‚Üí c≈©ng coi l√† sai
    }

    if (q.correct_answer) {
        if (q.variables) {
            const evalVal = evalExpression(q.correct_answer, q.variables);
            correctAnswerText = `${evalVal}`;
        } else {
            correctAnswerText = `${q.correct_answer}`;
        }
    }
}
            
            totalScore += questionScore;

            const row = summaryTable.insertRow();
            const questionNumCell = row.insertCell();
            questionNumCell.style.border = '1px solid #ccc';
            questionNumCell.style.padding = '8px';
            questionNumCell.textContent = `C√¢u ${q.q_num_display || (i + 1)}`;

            const userAnswerCell = row.insertCell();
            userAnswerCell.style.border = '1px solid #ccc';
            userAnswerCell.style.padding = '8px';
            userAnswerCell.textContent = userAnswerText;
            userAnswerCell.style.color = (resultText.startsWith('1/1') || resultText.includes('/4')) ? 'green' : 'red';

            const correctAnswerCell = row.insertCell();
            correctAnswerCell.style.border = '1px solid #ccc';
            correctAnswerCell.style.padding = '8px';
            correctAnswerCell.textContent = correctAnswerText;
            correctAnswerCell.style.color = 'green';
            
            const resultCell = row.insertCell();
            resultCell.style.border = '1px solid #ccc';
            resultCell.style.padding = '8px';
            resultCell.style.fontWeight = 'bold';
            resultCell.textContent = resultText;
            resultCell.style.color = (resultText === '1' || resultText === '4') ? 'green' : 'red';

            const scoreCell = row.insertCell();
            scoreCell.style.border = '1px solid #ccc';
            scoreCell.style.padding = '8px';
            scoreCell.style.fontWeight = 'bold';
            scoreCell.textContent = questionScore.toFixed(2);
        });

        quizContent.appendChild(summaryTable);
        // G·ª≠i t·ªïng ƒëi·ªÉm l√™n g·∫ßn t√™n h·ªçc sinh
        scoreSummary.innerHTML = `T·ªïng ƒëi·ªÉm: <span style="color: green; font-size: 1.2em;">${totalScore.toFixed(2)}</span>`;

        // B·∫Øt ƒë·∫ßu hi·ªÉn th·ªã chi ti·∫øt t·ª´ng c√¢u
        const detailTitle = document.createElement('h3');
        detailTitle.innerHTML = 'Chi ti·∫øt t·ª´ng c√¢u';
        detailTitle.style.borderTop = '1px solid #ccc';
        detailTitle.style.paddingTop = '20px';
        detailTitle.style.marginTop = '20px';
        quizContent.appendChild(detailTitle);

        // Hi·ªÉn th·ªã chi ti·∫øt t·ª´ng c√¢u h·ªèi nh∆∞ c≈©
        quizData.forEach((q, i) => {
            if (q.type === 'general_content_group') return;

            const questionBox = document.createElement('div');
            questionBox.className = 'question-box';
            questionBox.style.marginBottom = '30px';
            questionBox.style.padding = '15px';
            questionBox.style.border = '1px solid #ccc';
            questionBox.style.borderRadius = '8px';

            const questionHeader = document.createElement('h4');
            questionHeader.innerHTML = `C√¢u ${q.q_num_display || (i + 1)}: ${q.question}`;
            questionHeader.style.color = 'var(--dark-gray)';
            questionBox.appendChild(questionHeader);

            const sel = userSelections[i];
            let userAnswerText = 'Ch∆∞a tr·∫£ l·ªùi';
            let correctAnswerText = '';
            let isCorrect = false;

            if (q.type === 'type1') {
                const answersList = document.createElement('ul');
                answersList.style.listStyleType = 'none';
                answersList.style.padding = '0';
                answersList.style.fontSize = '1.1em';
                answersList.style.lineHeight = '1.6';

                q.answers.forEach((ans, idx) => {
                    const li = document.createElement('li');
                    const letter = String.fromCharCode(65 + idx);
                    li.innerHTML = `${letter}. ${ans.text}`;
                    if (sel && sel.answer && sel.answer[0] === letter) {
                        li.style.fontWeight = 'bold';
                        li.style.color = sel.answer[1] ? 'green' : 'red';
                        userAnswerText = `**${letter}**`;
                    }
                    if (ans.is_correct) {
                        correctAnswerText = `**${letter}**`;
                    }
                    answersList.appendChild(li);
                });
                questionBox.appendChild(answersList);
                isCorrect = (sel && !!sel.answer && sel.answer[1]);
            } else if (q.type === 'type2') {
                const optionsList = document.createElement('ul');
                optionsList.style.listStyleType = 'none';
                optionsList.style.padding = '0';
                optionsList.style.fontSize = '1.1em';
                optionsList.style.lineHeight = '1.6';

                userAnswerText = [];
                correctAnswerText = [];
                let subQuestionCorrectCount = 0;

                q.options.forEach((opt, idx) => {
                    const li = document.createElement('li');
                    const label = String.fromCharCode(97 + idx); // 'a' + idx
                    li.innerHTML = `${label}) ${opt.text}`;
                    li.style.marginBottom = '5px';

                    const userChoice = sel && Array.isArray(sel.answer) ? sel.answer[idx] : null;
                    const correctChoice = opt.correct_answer;
                    
                    if (userChoice !== null) {
                        li.innerHTML += ` ‚Üí B·∫°n ch·ªçn: ${userChoice}`;
                        if (userChoice === correctChoice) {
                            li.style.color = 'green';
                            subQuestionCorrectCount++;
                        } else {
                            li.style.color = 'red';
                        }
                    } else {
                        li.style.color = 'var(--dark-gray)';
                        li.innerHTML += ` ‚Üí Ch∆∞a tr·∫£ l·ªùi`;
                    }
                    userAnswerText.push(userChoice || '-');
                    correctAnswerText.push(correctChoice);
                    optionsList.appendChild(li);
                });
                questionBox.appendChild(optionsList);
                userAnswerText = userAnswerText.join(', ');
                correctAnswerText = correctAnswerText.join(', ');
                isCorrect = (subQuestionCorrectCount === q.options.length);
            } else if (q.type === 'type3') {
    if (sel && sel.answer !== null) {
        userAnswerText = `${sel.answer[0]}`;
        isCorrect = !!sel.answer[1];
    }
    if (q.variables) {
        const evalVal = evalExpression(q.correct_answer, q.variables);
        correctAnswerText = String(evalVal);
    } else {
        correctAnswerText = `${q.correct_answer}`;
    }
}
            
            const answerDisplay = document.createElement('p');
            answerDisplay.innerHTML = `
                <strong>C√¢u tr·∫£ l·ªùi c·ªßa b·∫°n:</strong> <span style="color: ${isCorrect ? 'green' : 'red'};">${userAnswerText}</span><br>
                <strong>ƒê√°p √°n ƒë√∫ng:</strong> <span style="color: green;">${correctAnswerText}</span>
            `;
            answerDisplay.style.borderTop = '1px dashed #ccc';
            answerDisplay.style.paddingTop = '10px';
            answerDisplay.style.marginTop = '15px';
            questionBox.appendChild(answerDisplay);
            quizContent.appendChild(questionBox);

            // N·∫øu c√≥ l·ªùi gi·∫£i th√¨ hi·ªÉn th·ªã
            if (q.solution && q.solution.trim() !== "") {
                const solutionBox = document.createElement('div');
                solutionBox.className = 'solution-box';
                solutionBox.style.marginTop = '10px';
                solutionBox.style.padding = '10px';
                solutionBox.style.borderLeft = '4px solid #4CAF50';
                solutionBox.style.backgroundColor = '#f9f9f9';
                solutionBox.innerHTML = `<b>L·ªùi gi·∫£i:</b><br>${q.solution}`;
                questionBox.appendChild(solutionBox);
            }
        });
        if (typeof MathJax !== 'undefined') {
            MathJax.typesetPromise([quizContent]);
        }
        // üîí Sau khi xu·∫•t k·∫øt qu·∫£: ·∫©n ho√†n to√†n panel b√™n ph·∫£i
        const resultsPanel = document.getElementById('results-panel');
        const toggleBtn = document.getElementById('toggle-results-btn');

        if (resultsPanel) {
            resultsPanel.style.display = 'none';
        }

        if (toggleBtn) {
            toggleBtn.style.display = 'none';
        }
    }
function showResults_HS_DIEM() {
    const quizContent = document.getElementById('quiz-content');
    quizContent.innerHTML = '';

    const resultsTitle = document.createElement('h2');
    resultsTitle.innerHTML = `H·ªç v√† t√™n: ${userInfo.name} - L·ªõp: ${userInfo.class}`;
    quizContent.appendChild(resultsTitle);
    // T·∫°o s·∫µn ch·ªó hi·ªÉn th·ªã t·ªïng ƒëi·ªÉm (ch∆∞a c√≥ s·ªë)
    const scoreSummary = document.createElement('h3');
    scoreSummary.style.color = 'var(--primary-color)';
    scoreSummary.style.fontWeight = 'bold';
    scoreSummary.innerHTML = `T·ªïng ƒëi·ªÉm: <span style="color: green; font-size: 1.2em;">...</span>`;
    quizContent.appendChild(scoreSummary);

    // S·ª≠ d·ª•ng gi√° tr·ªã t·ª´ c·∫•u h√¨nh ƒë√£ load t·ª´ JSON
    const diem_type1 = SCORING_CONFIG.type1;
    const diem_type2_1 = SCORING_CONFIG.type2_1;
    const diem_type2_2 = SCORING_CONFIG.type2_2;
    const diem_type2_3 = SCORING_CONFIG.type2_3;
    const diem_type2_4 = SCORING_CONFIG.type2_4;
    const diem_type3 = SCORING_CONFIG.type3;

    let totalScore = 0;

    // B·∫£ng th·ªëng k√™ t·ªïng h·ª£p
    const summaryTable = document.createElement('table');
    summaryTable.style.width = '100%';
    summaryTable.style.borderCollapse = 'collapse';
    summaryTable.style.marginBottom = '20px';
    summaryTable.style.boxShadow = '0 2px 5px rgba(0,0,0,0.05)';

    // CH·ªàNH S·ª¨A: B·ªé C·ªòT 'ƒê√°p √°n ƒë·ªÅ thi' v√† 'So s√°nh'
    const headers = ['C√¢u', 'Tr·∫£ l·ªùi HS', 'ƒêi·ªÉm'];
    const headerRow = summaryTable.insertRow();
    headers.forEach(headerText => {
        const th = document.createElement('th');
        th.style.border = '1px solid #ccc';
        th.style.padding = '8px';
        th.style.backgroundColor = 'var(--light-gray)';
        th.style.fontWeight = 'bold';
        th.textContent = headerText;
        headerRow.appendChild(th);
    });

    // Th√™m c√°c h√†ng d·ªØ li·ªáu
    quizData.forEach((q, i) => {
        if (q.type === 'general_content') return;

        const sel = userSelections[i];
        let userAnswerText = '‚Äî';
        let correctAnswerText = '';
        let resultText = '‚Äî';
        let questionScore = 0;

        if (q.type === 'type1') {
            const correctAns = q.answers.find(ans => ans.is_correct);
            correctAnswerText = correctAns ? String.fromCharCode(65 + q.answers.indexOf(correctAns)) : '‚Äî';
            userAnswerText = sel && sel.answer ? sel.answer[0] : '‚Äî';
            resultText = sel && sel.answer && sel.answer[1] ? '1' : '0';
            if (sel && sel.answer && sel.answer[1]) {
                questionScore = diem_type1;
            }
        } else if (q.type === 'type2') {
            correctAnswerText = q.options.map(opt => opt.correct_answer).join('');
            userAnswerText = sel && Array.isArray(sel.answer) ? sel.answer.join('') : '‚Äî';

            const subQuestionCorrectCount = sel ? (sel.correctCount ?? 0) : 0;
            resultText = `${subQuestionCorrectCount}`;

            // Logic t√≠nh ƒëi·ªÉm m·ªõi cho type2
            switch (subQuestionCorrectCount) {
                case 1:
                    questionScore = diem_type2_1;
                    break;
                case 2:
                    questionScore = diem_type2_2;
                    break;
                case 3:
                    questionScore = diem_type2_3;
                    break;
                case 4:
                    questionScore = diem_type2_4;
                    break;
                default:
                    questionScore = 0;
            }

        } else if (q.type === 'type3') {
            if (sel && sel.answer !== null) {
                userAnswerText = `${sel.answer[0]}`;
                isCorrect = !!sel.answer[1];
                resultText = isCorrect ? "1" : "0";
                if (isCorrect) {
                    questionScore = diem_type3;
                }
            } else {
                userAnswerText = "‚Äî";
                resultText = "0";
            }

            if (q.correct_answer) {
                if (q.variables) {
                    const evalVal = evalExpression(q.correct_answer, q.variables);
                    correctAnswerText = `${evalVal}`;
                } else {
                    correctAnswerText = `${q.correct_answer}`;
                }
            }
        }

        totalScore += questionScore;

        const row = summaryTable.insertRow();
        const questionNumCell = row.insertCell();
        questionNumCell.style.border = '1px solid #ccc';
        questionNumCell.style.padding = '8px';
        questionNumCell.textContent = `C√¢u ${q.q_num_display || (i + 1)}`;

        const userAnswerCell = row.insertCell();
        userAnswerCell.style.border = '1px solid #ccc';
        userAnswerCell.style.padding = '8px';
        userAnswerCell.textContent = userAnswerText;
        // ƒê√É B·ªé T√î M√ÄU ƒê·ªé/XANH TRONG C·ªòT 'Tr·∫£ l·ªùi HS' C·ª¶A B·∫¢NG T·ªîNG H·ª¢P

        // ƒê√É B·ªé C·ªòT SO S√ÅNH (resultCell)

        const scoreCell = row.insertCell();
        scoreCell.style.border = '1px solid #ccc';
        scoreCell.style.padding = '8px';
        scoreCell.style.fontWeight = 'bold';
        scoreCell.textContent = questionScore.toFixed(2);
        // ƒê√É B·ªé T√î M√ÄU ƒê·ªé/XANH TRONG C·ªòT 'ƒêi·ªÉm' C·ª¶A B·∫¢NG T·ªîNG H·ª¢P
    });

    quizContent.appendChild(summaryTable);
    // G·ª≠i t·ªïng ƒëi·ªÉm l√™n g·∫ßn t√™n h·ªçc sinh
    scoreSummary.innerHTML = `T·ªïng ƒëi·ªÉm: <span style="color: green; font-size: 1.2em;">${totalScore.toFixed(2)}</span>`;
    

    // B·∫Øt ƒë·∫ßu hi·ªÉn th·ªã chi ti·∫øt t·ª´ng c√¢u
    const detailTitle = document.createElement('h3');
    detailTitle.innerHTML = 'Chi ti·∫øt t·ª´ng c√¢u';
    detailTitle.style.borderTop = '1px solid #ccc';
    detailTitle.style.paddingTop = '20px';
    detailTitle.style.marginTop = '20px';
    quizContent.appendChild(detailTitle);

    // Hi·ªÉn th·ªã chi ti·∫øt t·ª´ng c√¢u h·ªèi
    quizData.forEach((q, i) => {
        if (q.type === 'general_content') return;

        const questionBox = document.createElement('div');
        questionBox.className = 'question-box';
        questionBox.style.marginBottom = '30px';
        questionBox.style.padding = '15px';
        questionBox.style.border = '1px solid #ccc';
        questionBox.style.borderRadius = '8px';

        const questionHeader = document.createElement('h4');
        questionHeader.innerHTML = `C√¢u ${q.q_num_display || (i + 1)}: ${q.question}`;
        questionHeader.style.color = 'var(--dark-gray)';
        questionBox.appendChild(questionHeader);

        const sel = userSelections[i];
        let userAnswerText = 'Ch∆∞a tr·∫£ l·ªùi';
        let correctAnswerText = '';
        let isCorrect = false;

        if (q.type === 'type1') {
            const answersList = document.createElement('ul');
            answersList.style.listStyleType = 'none';
            answersList.style.padding = '0';
            answersList.style.fontSize = '1.1em';
            answersList.style.lineHeight = '1.6';

            q.answers.forEach((ans, idx) => {
                const li = document.createElement('li');
                const letter = String.fromCharCode(65 + idx);
                li.innerHTML = `${letter}. ${ans.text}`;
                if (sel && sel.answer && sel.answer[0] === letter) {
                    li.style.fontWeight = 'bold';
                    // ƒê√É B·ªé T√î M√ÄU ƒê·ªé/XANH
                    userAnswerText = `**${letter}**`;
                }
                answersList.appendChild(li);
            });
            questionBox.appendChild(answersList);
            isCorrect = (sel && !!sel.answer && sel.answer[1]);
        } else if (q.type === 'type2') {
            const optionsList = document.createElement('ul');
            optionsList.style.listStyleType = 'none';
            optionsList.style.padding = '0';
            optionsList.style.fontSize = '1.1em';
            optionsList.style.lineHeight = '1.6';

            userAnswerText = [];
            correctAnswerText = [];
            let subQuestionCorrectCount = 0;

            q.options.forEach((opt, idx) => {
                const li = document.createElement('li');
                li.innerHTML = `${idx + 1}. ${opt.text}`;
                li.style.marginBottom = '5px';

                const userChoice = sel && Array.isArray(sel.answer) ? sel.answer[idx] : null;
                const correctChoice = opt.correct_answer;

                if (userChoice !== null) {
                    li.innerHTML += ` ‚Üí B·∫°n ch·ªçn: ${userChoice}`;
                    if (userChoice === correctChoice) {
                        // ƒê√É B·ªé T√î M√ÄU XANH
                        subQuestionCorrectCount++;
                    } else {
                        // ƒê√É B·ªé T√î M√ÄU ƒê·ªé
                    }
                } else {
                    li.style.color = 'var(--dark-gray)';
                    li.innerHTML += ` ‚Üí Ch∆∞a tr·∫£ l·ªùi`;
                }
                userAnswerText.push(userChoice || '-');
                correctAnswerText.push(correctChoice);
                optionsList.appendChild(li);
            });
            questionBox.appendChild(optionsList);
            userAnswerText = userAnswerText.join(', ');
            correctAnswerText = correctAnswerText.join(', ');
            isCorrect = (subQuestionCorrectCount === q.options.length);
        } else if (q.type === 'type3') {
            if (sel && sel.answer !== null) {
                userAnswerText = `${sel.answer[0]}`;
                isCorrect = !!sel.answer[1];
            }
            if (q.variables) {
                const evalVal = evalExpression(q.correct_answer, q.variables);
                correctAnswerText = String(evalVal);
            } else {
                correctAnswerText = `${q.correct_answer}`;
            }
        }

        const answerDisplay = document.createElement('p');
        // ƒê√É B·ªé T√î M√ÄU ƒê·ªé/XANH CHO C√ÇU TR·∫¢ L·ªúI C·ª¶A B·∫†N (userAnswerText)
        answerDisplay.innerHTML = `
            <strong>C√¢u tr·∫£ l·ªùi c·ªßa b·∫°n:</strong> <span>${userAnswerText}</span>
        `;
        answerDisplay.style.borderTop = '1px dashed #ccc';
        answerDisplay.style.paddingTop = '10px';
        answerDisplay.style.marginTop = '15px';
        questionBox.appendChild(answerDisplay);
        quizContent.appendChild(questionBox);

        
    });
    if (typeof MathJax !== 'undefined') {
        MathJax.typesetPromise([quizContent]);
    }
    // üîí Sau khi xu·∫•t k·∫øt qu·∫£: ·∫©n ho√†n to√†n panel b√™n ph·∫£i
        const resultsPanel = document.getElementById('results-panel');
        const toggleBtn = document.getElementById('toggle-results-btn');

        if (resultsPanel) {
            resultsPanel.style.display = 'none';
        }

        if (toggleBtn) {
            toggleBtn.style.display = 'none';
        }
}

function showResults_HS() {
     // S·ª≠a: X√≥a n·ªôi dung c≈© c·ªßa b·∫£ng tr∆∞·ªõc khi th√™m k·∫øt qu·∫£ m·ªõi
    document.querySelectorAll('.results-table-body').forEach(tbody => {
        tbody.innerHTML = '';
    });
    const quizContent = document.getElementById('quiz-content');
    quizContent.innerHTML = '';

    const resultsTitle = document.createElement('h2');
    resultsTitle.innerHTML = `H·ªç v√† t√™n: ${userInfo.name} - L·ªõp: ${userInfo.class}`;
    quizContent.appendChild(resultsTitle);

    const submissionNote = document.createElement('h3');
    submissionNote.innerHTML = 'K·∫øt qu·∫£ b√†i l√†m c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n.';
    submissionNote.style.color = 'var(--primary-color)';
    submissionNote.style.fontWeight = 'bold';
    //quizContent.appendChild(submissionNote);

    // Hi·ªÉn th·ªã chi ti·∫øt t·ª´ng c√¢u h·ªèi nh∆∞ c≈©
    quizData.forEach((q, i) => {
        if (q.type === 'general_content') return;

        const questionBox = document.createElement('div');
        questionBox.className = 'question-box';
        questionBox.style.marginBottom = '30px';
        questionBox.style.padding = '15px';
        questionBox.style.border = '1px solid #ccc';
        questionBox.style.borderRadius = '8px';

        const questionHeader = document.createElement('h4');
        questionHeader.innerHTML = `C√¢u ${q.q_num_display || (i + 1)}: ${q.question}`;
        questionHeader.style.color = 'var(--dark-gray)';
        questionBox.appendChild(questionHeader);

        const sel = userSelections[i];
        let userAnswerText = 'Ch∆∞a tr·∫£ l·ªùi';

        // Hi·ªán ƒë√°p √°n t√πy lo·∫°i c√¢u, nh∆∞ng KH√îNG T√î M√ÄU V√Ä KH√îNG HI·ªÇN TH·ªä ƒê√ÅP √ÅN ƒê√öNG
        if (q.type === 'type1') {
            const answersList = document.createElement('ul');
            answersList.style.listStyleType = 'none';
            answersList.style.padding = '0';
            answersList.style.fontSize = '1.1em';
            answersList.style.lineHeight = '1.6';

            q.answers.forEach((ans, idx) => {
                const li = document.createElement('li');
                const letter = String.fromCharCode(65 + idx);
                li.innerHTML = `${letter}. ${ans.text}`;
                if (sel && sel.answer && sel.answer[0] === letter) {
                    li.style.fontWeight = 'bold';
                    userAnswerText = `**${letter}**`;
                }
                answersList.appendChild(li);
            });
            questionBox.appendChild(answersList);

        } else if (q.type === 'type2') {
            const optionsList = document.createElement('ul');
            optionsList.style.listStyleType = 'none';
            optionsList.style.padding = '0';
            optionsList.style.fontSize = '1.1em';
            optionsList.style.lineHeight = '1.6';

            userAnswerText = [];

            q.options.forEach((opt, idx) => {
                const li = document.createElement('li');
                li.innerHTML = `${idx + 1}. ${opt.text}`;
                li.style.marginBottom = '5px';

                const userChoice = sel && Array.isArray(sel.answer) ? sel.answer[idx] : null;
                
                if (userChoice !== null) {
                    li.innerHTML += ` ‚Üí B·∫°n ch·ªçn: ${userChoice}`;
                } else {
                    li.innerHTML += ` ‚Üí Ch∆∞a tr·∫£ l·ªùi`;
                }

                userAnswerText.push(userChoice || '-');
                optionsList.appendChild(li);
            });
            questionBox.appendChild(optionsList);
            userAnswerText = userAnswerText.join(', ');

        } else if (q.type === 'type3') {
            if (sel && sel.answer !== null) {
                userAnswerText = `${sel.answer[0]}`;
            }
        }
        
        const answerDisplay = document.createElement('p');
        answerDisplay.innerHTML = `
            <strong>C√¢u tr·∫£ l·ªùi c·ªßa b·∫°n:</strong> <span>${userAnswerText}</span>
        `;
        answerDisplay.style.borderTop = '1px dashed #ccc';
        answerDisplay.style.paddingTop = '10px';
        answerDisplay.style.marginTop = '15px';
        questionBox.appendChild(answerDisplay);
        
        quizContent.appendChild(questionBox);
    });
    if (typeof MathJax !== 'undefined') {
        MathJax.typesetPromise([quizContent]);
    }
    // üîí Sau khi xu·∫•t k·∫øt qu·∫£: ·∫©n ho√†n to√†n panel b√™n ph·∫£i
        const resultsPanel = document.getElementById('results-panel');
        const toggleBtn = document.getElementById('toggle-results-btn');

        if (resultsPanel) {
            resultsPanel.style.display = 'none';
        }

        if (toggleBtn) {
            toggleBtn.style.display = 'none';
        }
}
function xuatCSV() {
    // S·ª≠ d·ª•ng bi·∫øn ƒë√£ c·∫≠p nh·∫≠t t·ª´ JSON
    if (QUIZ_MODE_CSV === "chophepxuatcsv") {
        let message = `B·∫°n c√≥ ch·∫Øc mu·ªën xu·∫•t file CSV? Sau khi xu·∫•t th√¨ kh√¥ng th·ªÉ ti·∫øp t·ª•c l√†m b√†i.`;
        showCustomAlert(
            message,
            () => {
                if (typeof exportCSV === "function") {
                    exportCSV();      // G·ªçi h√†m export c·ªßa b·∫°n
                    lockAnswerInputs(); // Kh√≥a kh√¥ng cho l√†m ti·∫øp
                }
            },
            () => {} // H√†m cho n√∫t H·ªßy (kh√¥ng l√†m g√¨ c·∫£)
        );
    } 
}
function exportCSV() {
    const originalOrderData = quizData
        .filter(q => q.type !== 'general_content')
        .sort((a, b) => a.original_index - b.original_index);

    const answersFormatted = [];
    const resultsFormatted = [];
    const typesFormatted = [];

    originalOrderData.forEach(originalQuestion => {
        const currentIndex = quizData.findIndex(q => q.original_index === originalQuestion.original_index);
        const sel = userSelections[currentIndex];

        if (!sel) {
            answersFormatted.push("");
            resultsFormatted.push("");
            typesFormatted.push(originalQuestion.type);
        } else {
            typesFormatted.push(sel.type);
            if (sel.type === 'type1' || sel.type === 'type3') {
                answersFormatted.push(sel.answer ? sel.answer[0] : "");
                resultsFormatted.push(sel.answer ? sel.answer[1] : 0);
            } else if (sel.type === 'type2') {
                answersFormatted.push(Array.isArray(sel.answer) ? sel.answer.join(",") : "");
                resultsFormatted.push(sel.correctCount ?? 0);
            }
        }
    });

    const headers = ["Th·ªùi gian n·ªôp","H·ªç v√† t√™n","L·ªõp","T√™n b√†i ki·ªÉm tra", ...originalOrderData.map((_,i)=>"C√¢u "+(i+1)),"T·ªïng ƒëi·ªÉm"];
    
    const now = new Date().toLocaleString("vi-VN");
    const totalScore = calcTotalScore(resultsFormatted, typesFormatted);

    const row1 = [now, userInfo.name, userInfo.class, tenBaiKiemTra, ...answersFormatted];
    const row2 = ["","","","-> K·∫øt qu·∫£:", ...resultsFormatted, totalScore];

    const rows = [headers, row1, row2];
    const csvContent = "Ôªø" + rows.map(r => r.map(cell => {
        if (cell == null) return "";
        const s = String(cell);
        return (s.includes(",") || s.includes('"')) ? `"${s.replace(/"/g,'""')}"` : s;
    }).join(",")).join("\n");

    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.setAttribute("href", url);
    link.setAttribute("download", `KetQua_${userInfo.name}_${Date.now()}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// ƒë·ªïi size:
let currentFontSize = null;   // null = ƒëang auto
const minFont = 8;
const maxFont = 40;

function applyFontSize(value) {
    document.documentElement
        .style
        .setProperty('--question-font-size', value);

    if (window.MathJax) {
        MathJax.typesetPromise();
    }
}

function increaseFont() {
    if (currentFontSize === null) {
        currentFontSize = 16; // l·∫•y m·ªëc h·ª£p l√Ω
    } else if (currentFontSize < maxFont) {
        currentFontSize += 2;
    }
    applyFontSize(currentFontSize + 'px');
}

function decreaseFont() {
    if (currentFontSize === null) {
        currentFontSize = 12;
    } else if (currentFontSize > minFont) {
        currentFontSize -= 2;
    }
    applyFontSize(currentFontSize + 'px');
}

// H√†m t√≠nh ƒëi·ªÉm gi·ªëng b√™n GS
function calcTotalScore(results, types) {
    let total = 0;
    results.forEach((res, i) => {
        const type = types[i];
        const val = Number(res) || 0;
        switch (type) {
            case "type1":
                total += val === 1 ? 0.25 : 0;
                break;
            case "type2":
                if (val === 1) total += 0.1;
                else if (val === 2) total += 0.25;
                else if (val === 3) total += 0.5;
                else if (val === 4) total += 1;
                break;
            case "type3":
                total += val === 1 ? 1 : 0;
                break;
        }
    });
    return total.toFixed(2);
}

// Ch·∫∑n chu·ªôt ph·∫£i
document.addEventListener("contextmenu", function (e) {
    e.preventDefault();
});

// Ch·∫∑n c√°c ph√≠m t·∫Øt quan tr·ªçng
document.addEventListener("keydown", function (e) {
    // F12
    if (e.key === "F12") {
        e.preventDefault();
    }
    // Ctrl+Shift+I ho·∫∑c Ctrl+Shift+C
    if (e.ctrlKey && e.shiftKey && (e.key === "I" || e.key === "C")) {
        e.preventDefault();
    }
    // Ctrl+U (View Source)
    if (e.ctrlKey && e.key.toLowerCase() === "u") {
        e.preventDefault();
    }
    // Ctrl+S (Save page)
    if (e.ctrlKey && e.key.toLowerCase() === "s") {
        e.preventDefault();
    }
});


    </script>
</body>
</html>
